<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Zuul Hands on - part 5 - Job Secrets - Software Factory</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="./zuul-hands-on-part-5-job-secrets.html">

        <meta name="author" content="tristanC" />
        <meta name="keywords" content="zuul-hands-on-series" />
        <meta name="description" content="In this article, we will explain how to use job secrets stored directly in the git repositories of projects. This article is part of the Zuul hands-on series. The examples and commands that follow are intended to be run on a Software Factory sandbox where a demo-repo repository exists. You …" />

        <meta property="og:site_name" content="Software Factory" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Zuul Hands on - part 5 - Job Secrets"/>
        <meta property="og:url" content="./zuul-hands-on-part-5-job-secrets.html"/>
        <meta property="og:description" content="In this article, we will explain how to use job secrets stored directly in the git repositories of projects. This article is part of the Zuul hands-on series. The examples and commands that follow are intended to be run on a Software Factory sandbox where a demo-repo repository exists. You …"/>
        <meta property="article:published_time" content="2018-11-20" />
            <meta property="article:section" content="blog" />
            <meta property="article:tag" content="zuul-hands-on-series" />
            <meta property="article:author" content="tristanC" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/solarizedlight.css" rel="stylesheet">
        <link href="./theme/css/html4css1.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>


        <link href="./blog.xml" type="application/atom+xml" rel="alternate"
              title="Software Factory blog ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src="./images/SoftwareFactory-logo.svg" width="20px"/> Software Factory            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/contact.html">
                             Contact
                          </a></li>
                        <li class="active">
                            <a href="./category/blog.html">Blog</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./zuul-hands-on-part-5-job-secrets.html"
                       rel="bookmark"
                       title="Permalink to Zuul Hands on - part 5 - Job Secrets">
                        Zuul Hands on - part 5 - Job Secrets
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2018-11-20T00:00:00+00:00"> Tue 20 November 2018</time>
    </span>


            <span class="label label-default">By</span>
            <a href="./author/tristanc.html"><i class="fa fa-user"></i> tristanC</a>



<span class="label label-default">Tags</span>
	<a href="./tag/zuul-hands-on-series.html">zuul-hands-on-series</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>In this article, we will explain how to use job secrets stored directly
in the git repositories of projects.</p>
<p>This article is part of the <a class="reference external" href="./tag/zuul-hands-on-series.html">Zuul hands-on series</a>.</p>
<p>The examples and commands that follow are intended to be run on a Software Factory
sandbox where a <strong>demo-repo</strong> repository exists. You should have such an environment
after following the previous articles in this series:</p>
<ul class="simple">
<li>To deploy a Software Factory sandbox please read the <a class="reference external" href="./how-to-setup-a-software-factory-sandbox.html">first article of the series</a>.</li>
<li>To create the <strong>demo-repo</strong> repository, please follow the sections <a class="reference external" href="./zuul-hands-on-part-2-your-first-gated-patch-with-zuul.html#clone-the-config-repository">Clone the config repository</a>
and <a class="reference external" href="./zuul-hands-on-part-2-your-first-gated-patch-with-zuul.html#define-the-demo-repo-repository">Define the demo-repo repository</a> sections.</li>
</ul>
<p>Incidentally, most of the links reference <em>sftests.com</em> which is the default
domain of the sandbox. Make sure to adapt the links if necessary.</p>
<p>If you have already deployed a Software Factory sandbox and created a snapshot as
suggested, you can restore this snapshot in order to follow this article on a clean environment.
In that case make sure the virtual machine's time is correct post
restoration. If not fix it by running</p>
<div class="highlight"><pre><span></span>systemctl stop ntpd<span class="p">;</span> ntpd -gq<span class="p">;</span> systemctl start ntpd
</pre></div>
<div class="section" id="projects-types-config-vs-untrusted">
<h2>Projects Types: config vs untrusted</h2>
<p>Zuul defines two categories of projects:</p>
<ul class="simple">
<li><strong>config</strong> projects, and</li>
<li><strong>untrusted</strong> projects.</li>
</ul>
<p>The main difference is that config projects are <strong>protected</strong> and changes to
their Zuul configuration <strong>are not tested speculatively</strong>.
Untrusted projects' configuration changes are tested speculatively before
being merged, while config project configuration are only effective after
being merged.</p>
<p>Let's vizualize the difference on some workflow diagrams:</p>
<div class="section" id="untrusted-projects">
<h3>Untrusted projects</h3>
<p>Let's assume <em>A</em> is an incoming patch to an <strong>untrusted</strong> project. <em>A</em>
modifies the <em>job-1</em> being run in the <strong>check</strong> gate (<em>job-1</em>,
the modified job is pictured in orange below). Merging this change will look
like this in terms of workflow:</p>
<img alt="None" src="images/zuul-hands-on-part6-untrusted-project-workflow.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>The change gets tested speculatively, therefore the change to <em>job-1</em>
is used immediately in the <strong>check</strong> and <strong>gate</strong> pipeline, <strong>before</strong> being
merged.</p>
</div>
<div class="section" id="config-projects">
<h3>Config projects</h3>
<p>Let's assume now that <em>A</em> is an incoming patch on a <strong>config</strong> project.
Merging this change will look like this in terms of workflow:</p>
<img alt="None" src="images/zuul-hands-on-part6-config-project-workflow-A.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>This time, the change to <em>job-1</em> is not applied in the <strong>check</strong> or <strong>gate</strong>
pipeline. The rationale here is that changes to a config project are impactful
and need to be reviewed by humans before being run automatically. If they
were run as soon as the check pipeline, nothing would prevent a malicious user
from leaking passwords used in the jobs, for example.</p>
<p>Once A is merged, subsequent patches get tested with the new changes:</p>
<img alt="None" src="images/zuul-hands-on-part6-config-project-workflow-B.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Regarding secrets, the main difference between <strong>untrusted</strong> and <strong>config</strong>
projects is that for security reasons, untrusted projects' secrets shall only
be used in <a class="reference external" href="https://zuul-ci.org/docs/zuul/latest/config/pipeline.html#attr-pipeline.post-review">post-review</a> pipelines such as the pre-defined
<strong>&quot;periodic&quot;</strong> or <strong>&quot;post&quot;</strong>.</p>
</div>
</div>
<div class="section" id="using-a-secret-in-a-config-project">
<h2>Using a secret in a config project</h2>
<p>A typical use case is a secret needed by a publishing or deployment job.
Actually, the <strong>base</strong> job (built-in in Software Factory) is using a secret to
upload job logs to the log server defined in the config project's
<strong>zuul.d/_secret_sflogs.yaml</strong> file, and used by the base job defined in
<strong>zuul.d/_jobs-base.yaml</strong> file.</p>
<p>To encrypt a custom secret, you can use the <a class="reference external" href="https://zuul-ci.org/docs/zuul-client/">zuul-client</a> script
from the Zuul source repository. This script needs
the tenant name and project name to retrieve the project's public key and
properly encrypt the secret. We will use it to encrypt a custom secret
for the config project.</p>
<p>You can install from source here <a class="reference external" href="https://zuul-ci.org/docs/zuul-client/">zuul-client</a> , or through pip:</p>
<div class="highlight"><pre><span></span>pip install zuul-client
</pre></div>
<div class="highlight"><pre><span></span>zuul-client -v --insecure --zuul-url https://sftests.com/zuul encrypt --project config --tenant <span class="nb">local</span>
&lt;write your secrets here and <span class="nb">exit</span> with Ctrl+D&gt;
...
DEBUG:urllib3.connectionpool:https://sftests.com:443 <span class="s2">&quot;GET /zuul/api/tenant/local/key/config.pub HTTP/1.1&quot;</span> <span class="m">200</span> <span class="m">800</span>
DEBUG:zuul-client:Calling openssl
DEBUG:zuul-client:calling <span class="s2">&quot;openssl version&quot;</span>
DEBUG:zuul-client:calling <span class="s2">&quot;openssl rsa -text -pubin -in /tmp/tmpti0h47uu&quot;</span>
writing RSA key
INFO:zuul-client:Public key length: <span class="m">4096</span> bits <span class="o">(</span><span class="m">512</span> bytes<span class="o">)</span>
INFO:zuul-client:Max plaintext length per chunk: <span class="m">470</span> bytes
INFO:zuul-client:Input plaintext length: <span class="m">10</span> bytes
INFO:zuul-client:Number of chunks: <span class="m">1</span>
DEBUG:zuul-client:calling <span class="s2">&quot;openssl rsautl -encrypt -oaep -pubin -inkey /tmp/tmpti0h47uu&quot;</span> with each data chunk:
DEBUG:zuul-client:      chunk <span class="m">1</span>

- secret:
    name: &lt;name&gt;
    data:
      &lt;fieldname&gt;: !encrypted/pkcs1-oaep
        - joTrPXkIVs9mp9Kh88ly1HAE64Ygu5yRxlrPslb8vG7qNA2isRdvhwO5I5+4WhfjNK43q
          HjCdeIc9LmqZHi5cglYiHHjHZYNhDXatOUt+T7fotyb+VMkXrZj8EiHINgggbJH+/lHBU
          YFhyqjBojyTq1TQUl7FiexTfZS2KFU1st5GgPNcxJJQ2g4lcyXuWNFauC5C4PU08mn1mi

<span class="c1"># You can also check and get the public key manually:</span>
curl -k https://sftests.com/zuul/api/tenant/local/key/config.pub
</pre></div>
<p>Use the --infile option if the secret is a certificate file or a SSH key.
Write the output to a new zuul configuration file in the config
project like that:</p>
<div class="highlight"><pre><span></span><span class="c1"># config/zuul.d/my-secret.yaml</span><span class="w"></span>
<span class="nn">---</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secret</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-publication-secret</span><span class="w"></span>
<span class="w">    </span><span class="nt">data</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="c1"># Extra cleartext data can be added to a secret</span><span class="w"></span>
<span class="w">      </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">publication-host.example.com</span><span class="w"></span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="kt">!encrypted/pkcs1-oaep</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joTrPXkIVs9mp9Kh88ly1HAE64Ygu5yRxlrPslb8vG7qNA2isRdvhwO5I5+4WhfjNK43q</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">HjCdeIc9LmqZHi5cglYiHHjHZYNhDXatOUt+T7fotyb+VMkXrZj8EiHINgggbJH+/lHBU</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">YFhyqjBojyTq1TQUl7FiexTfZS2KFU1st5GgPNcxJJQ2g4lcyXuWNFauC5C4PU08mn1mi</span><span class="w"></span>
</pre></div>
<p>Then the secret can be attached to a job like so:</p>
<div class="highlight"><pre><span></span><span class="c1"># config/zuul.d/my-job.yaml</span><span class="w"></span>
<span class="nn">---</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-publication-job</span><span class="w"></span>
<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">playbooks/my-publication.yaml</span><span class="w"></span>
<span class="w">    </span><span class="nt">secrets</span><span class="p">:</span><span class="w"></span>
<span class="w">     </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">publication_secret</span><span class="w"></span>
<span class="w">       </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-publication-secret</span><span class="w"></span>
</pre></div>
<p>Finally, when the playbook is executed, the secret content will be decrypted
and available as the secret name dictionary:</p>
<div class="highlight"><pre><span></span><span class="c1"># config/playbooks/my-publication.yaml</span><span class="w"></span>
<span class="nn">---</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span><span class="w"></span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="c1"># Copy secret to a configuration file</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install secret</span><span class="w"></span>
<span class="w">      </span><span class="nt">copy</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">publication_secret.password</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;.publication-secret&quot;</span><span class="w"></span>
<span class="w">      </span><span class="nt">no_log</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Uses as an environment variable</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Run publication command</span><span class="w"></span>
<span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">env</span><span class="w"></span>
<span class="w">      </span><span class="nt">environment</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">MY_SECRET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">publication_secret.password</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">MY_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">publication_secret.hostname</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Remove secret file</span><span class="w"></span>
<span class="w">      </span><span class="nt">file</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;.publication-secret&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">absent</span><span class="w"></span>
</pre></div>
<p>Commit the 3 files and merge them in the config project:</p>
<div class="highlight"><pre><span></span><span class="go">git add -A</span>
<span class="go">git commit -m &quot;Provide my publication job&quot;</span>
<span class="go">git review</span>
<span class="gp"># </span>and approve the change on Gerrit and <span class="nb">wait</span> <span class="k">for</span> the change to be merged
</pre></div>
<p>Then we can test that the new job by adding it to the demo-repo's pipeline.</p>
<div class="highlight"><pre><span></span><span class="c1"># demo-repo/.zuul.yaml</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">project</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">check</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">jobs</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-publication-job</span><span class="w"></span>
</pre></div>
<p>Commit this file in the demo-repo project and use git-review to trigger the
job execution:</p>
<div class="highlight"><pre><span></span><span class="go">git add .zuul.yaml</span>
<span class="go">git commit -m &quot;Configure project pipelines&quot;</span>
<span class="go">git review</span>
</pre></div>
<img alt="None" src="images/zuul-hands-on-part6-c1.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>To open the same menu as the image above go to <a class="reference external" href="https://sftests.com/zuul/t/local/builds">Zuul's Build page (sftests.com)</a>. Here in the top lines of the table you can find the <strong>my-publication-job</strong> in the job column, click on SUCCESS in the Result column. You will find below Artifacts, and under it <strong>ARA report</strong> click on it.
On this page will be all playbook tasks. <strong>Expand Run publication command</strong> task.</p>
<p>As you can see, the job can be used by any project and the playbook is
executed with the secret decrypted. The <strong>env</strong> command is leaking
the secret content, thus when writing job that uses secret,
it is recommended to make sure the secret is not exposed
during the job execution.</p>
<p>Because the job is defined in a config project, a malicious user can
not submit a review with a new playbook task to dump the secret
content because the job's content is not evaluated speculatively.
Read below for more <a class="reference internal" href="#security-considerations">Security Considerations</a>.</p>
</div>
<div class="section" id="using-an-untrusted-project-secret">
<h2>Using an untrusted-project secret</h2>
<p>Secrets don't have to be set exclusively in config projects. In this example
we are going to create a publish-to-pypi job for the demo-repo
project so that it is published to pypi on release. To do that we will
use the <strong>build-python-release</strong> and <strong>upload-pypi</strong> roles from <a class="reference external" href="https://zuul-ci.org/docs/zuul-jobs/">zuul-jobs</a>.</p>
<p>Clone the <strong>demo-repo</strong> and provision it with
<a class="reference external" href="./demo-codes/hoz-4-demo-repo.tgz">this demo code</a> .</p>
<p>The default release process uses wheel packaging, thus you will have
to update the setup.py to use setuptools:</p>
<div class="highlight"><pre><span></span><span class="c1"># demo-repo/setup.py</span>
<span class="kn">import</span> <span class="nn">setuptools</span>

<span class="n">setuptools</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">)</span>
</pre></div>
<p>Also make sure the following packages are installed on the node running the job.
The sandbox is using the runC driver to run tests so install the packages
on the Software Factory instance directly:</p>
<div class="highlight"><pre><span></span>sudo yum install -y python-wheel python-twine
</pre></div>
<p>Go back to demo-repo project and encrypt a fake pypi account password (since we don't want to actually
publish this demo project) using this command:</p>
<div class="highlight"><pre><span></span>zuul-client -v --insecure --zuul-url https://sftests.com/zuul encrypt --tenant <span class="nb">local</span> --project demo-repo
</pre></div>
<p>Create this demo-repo zuul configuration and replace the password payload with
the output of <cite>zuul-client</cite> :</p>
<div class="highlight"><pre><span></span><span class="c1"># demo-repo/.zuul.yaml</span><span class="w"></span>
<span class="nn">---</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secret</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-pypi-secret</span><span class="w"></span>
<span class="w">    </span><span class="nt">data</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-pypi-account</span><span class="w"></span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="kt">!encrypted/pkcs1-oaep</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vY1AfQZimyeFgKchVZYoF9hTcF511U6wS7PZFrzX/+po15a45Nt4mia/RNz/3+dRhi8ip</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">6xIBD8S7JzrwmfovGg1fDPtNwSFO+awZ5f/B6aH35X0nuC5OQ3Jeu641inhNonuSKJ6Sh</span><span class="w"></span>
<span class="w">          </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-upload-pypi</span><span class="w"></span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Release wheel to pypi using my-pypi-account</span><span class="w"></span>
<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">playbooks/publish/release.yaml</span><span class="w"></span>
<span class="w">    </span><span class="nt">post-run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">playbooks/publish/pypi.yaml</span><span class="w"></span>
<span class="w">    </span><span class="nt">secrets</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pypi_info</span><span class="w"></span>
<span class="w">        </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-pypi-secret</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">project</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">check</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">jobs</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tox-pep8</span><span class="w"></span>
<span class="w">    </span><span class="nt">gate</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">jobs</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tox-pep8</span><span class="w"></span>
<span class="w">    </span><span class="nt">release</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">jobs</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-upload-pypi</span><span class="w"></span>
</pre></div>
<p>Create the run playbook:</p>
<div class="highlight"><pre><span></span><span class="c1"># demo-repo/playbooks/publish/release.yaml</span><span class="w"></span>
<span class="nn">---</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">build-python-release</span><span class="w"></span>
</pre></div>
<p>And the post playbook:</p>
<div class="highlight"><pre><span></span><span class="c1"># demo-repo/playbooks/publish/pypi.yaml</span><span class="w"></span>
<span class="nn">---</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">all</span><span class="w"></span>
<span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">upload-pypi</span><span class="w"></span>
<span class="w">      </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">zuul_success | bool</span><span class="w"></span>
</pre></div>
<p>Commit the 3 files and merge them in the demo-repo project:</p>
<div class="highlight"><pre><span></span><span class="go">git add -A</span>
<span class="go">git commit -m &quot;Provide my upload-pypi job&quot;</span>
<span class="go">git review</span>
<span class="gp"># </span>and approve the change on Gerrit and <span class="nb">wait</span> <span class="k">for</span> the change to be merged
</pre></div>
<p>To test the publication job, push a new tag:</p>
<div class="highlight"><pre><span></span><span class="nb">cd</span> demo-repo
git tag -a -m <span class="m">0</span>.0.1 <span class="m">0</span>.0.1
git push gerrit <span class="m">0</span>.0.1
</pre></div>
<p>Resulting in:</p>
<img alt="None" src="images/zuul-hands-on-part6-c2.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<img alt="None" src="images/zuul-hands-on-part6-c3.png" />
<p>The error is expected because the password was incorrect.</p>
<p>To restart the job, you can use the <cite>zuul reenqueue</cite> command (on the Software
Factory instance):</p>
<div class="highlight"><pre><span></span>zuul enqueue-ref --tenant <span class="nb">local</span> --trigger gerrit <span class="se">\</span>
     --pipeline release --project demo-repo <span class="se">\</span>
     --ref refs/tags/0.0.1 <span class="se">\</span>
     --newrev git-commit-sha1
</pre></div>
<p>To update the tag content, it's recommended to push a new tag
as Zuul doesn't handle reference deletion gracefully.</p>
<p>The job can be used by any project, but only in a
<strong>post-review</strong> pipeline (e.g. <strong>post</strong> or <strong>release</strong>). Attempting
to modify the release playbook and adding the job to
a check pipeline will result in a Zuul configuration
error to prevent malicious access to the secret.</p>
</div>
<div class="section" id="security-considerations-1">
<span id="security-considerations"></span><h2>Security considerations</h2>
<p>Here are some security considerations when using secrets
in Zuul jobs:</p>
<ul class="simple">
<li>Secrets may only be used by jobs defined within the same project.</li>
<li>Config project secrets can be used in check pipelines, but
be careful to prevent unexpected usage. For example, secrets
shouldn't be written to disk in a pre run as a job's user may be
able to access them during the speculative run phase.</li>
<li>Be wary when holding a node that have used a secret because the secret may be
recovered from the swap or the filesystem journal.</li>
<li>Publication jobs can use the <strong>post-review</strong> job attribute
to prevent usage in the check pipeline. Note that <strong>post-review</strong> is
automatically set for untrusted projects' jobs using secrets.</li>
<li>Jobs that have access to protected resources can be restricted
to specific projects using the <strong>allowed-projects</strong> job attribute.</li>
</ul>
</div>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./sprint-2024-aug-09-to-2024-aug-28-summary.html">Sprint 2024 Aug 09 to 2024 Aug 28 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jul-19-to-2024-aug-07-summary.html">Sprint 2024 Jul 19 to 2024 Aug 07 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-28-to-2024-jul-17-summary.html">Sprint 2024 Jun 28 to 2024 Jul 17 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-07-to-2024-jun-26-summary.html">Sprint 2024 Jun 07 to 2024 Jun 26 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-may-16-to-2024-jun-05-summary.html">Sprint 2024 May 16 to 2024 Jun 05 summary</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 Red Hat
           &middot; Powered by <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>
           &middot; This work is licensed under a
               <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                 Creative Commons Attribution 4.0 International License
               </a>.
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>




</body>
</html>