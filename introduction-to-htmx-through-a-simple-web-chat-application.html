<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Introduction to </> htmx through a Simple WEB chat application - Software Factory</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="./introduction-to-htmx-through-a-simple-web-chat-application.html">

        <meta name="author" content="Fabien" />
        <meta name="description" content=".literal { border-radius: 6px; padding: 1px 1px; background-color: rgba(27,31,35,.05); } This post aims to introduce htmx usage through a very simple chat application. We&#39;ll expose and explain some code snippets from a playground project named simple chat. The playground application is written in Haskell but htmx usage is …" />

        <meta property="og:site_name" content="Software Factory" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Introduction to &lt;/&gt; htmx through a Simple WEB chat application"/>
        <meta property="og:url" content="./introduction-to-htmx-through-a-simple-web-chat-application.html"/>
        <meta property="og:description" content=".literal { border-radius: 6px; padding: 1px 1px; background-color: rgba(27,31,35,.05); } This post aims to introduce htmx usage through a very simple chat application. We&#39;ll expose and explain some code snippets from a playground project named simple chat. The playground application is written in Haskell but htmx usage is …"/>
        <meta property="article:published_time" content="2022-09-26" />
            <meta property="article:section" content="blog" />
            <meta property="article:author" content="Fabien" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/solarizedlight.css" rel="stylesheet">
        <link href="./theme/css/html4css1.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>


        <link href="./blog.xml" type="application/atom+xml" rel="alternate"
              title="Software Factory blog ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src="./images/SoftwareFactory-logo.svg" width="20px"/> Software Factory            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/contact.html">
                             Contact
                          </a></li>
                        <li class="active">
                            <a href="./category/blog.html">Blog</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./introduction-to-htmx-through-a-simple-web-chat-application.html"
                       rel="bookmark"
                       title="Permalink to Introduction to </> htmx through a Simple WEB chat application">
                        Introduction to &lt;/&gt; htmx through a Simple WEB chat application
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2022-09-26T00:00:00+00:00"> Mon 26 September 2022</time>
    </span>


            <span class="label label-default">By</span>
            <a href="./author/fabien.html"><i class="fa fa-user"></i> Fabien</a>



    
</footer><!-- /.post-info -->                    </div>
                </div>
                <style type="text/css">

  .literal {
    border-radius: 6px;
    padding: 1px 1px;
    background-color: rgba(27,31,35,.05);
  }

</style><p>This post aims to introduce <a class="reference external" href="https://htmx.org">htmx</a> usage through a very simple chat
application. We'll expose and explain some code snippets from a
<a class="reference external" href="https://github.com/morucci/schat/tree/16291940ab602a7c888c1a0f82acd995b24ae267">playground project</a> named simple chat.</p>
<img alt="sChat UI" src="images/schat.png" />
<p>The playground application is written in Haskell but htmx usage is not
tied to a specific language, and it can be used with any server side
language such as Python.</p>
<div class="section" id="what-is-htmx-1">
<span id="what-is-htmx"></span><h2>What is htmx ?</h2>
<p>htmx provides an easy way to build dynamic WEB frontends without the
need to write a ton of Javascript code. htmx is itself a Javascript
library that:</p>
<ul class="simple">
<li>reacts to HTML attributes to fire events like AJAX requests</li>
<li>updates the DOM based on server responses</li>
</ul>
<p>With htmx any HTML element can issue requests to the backend, and every
element can be updated via the backend (not just the entire page).</p>
</div>
<div class="section" id="why-1">
<span id="why"></span><h2>Why ?</h2>
<p>Htmx brings lot of facilities to build WEB applications using only your
favorite backend language and simply relying on htmx facilities for
handling frontend events and rendering frontend elements. Indeed it is
often difficult to manage two different toolchains for the backend and
the frontend that needs to share data types.</p>
</div>
<div class="section" id="usage-of-htmx-to-build-the-schat-application">
<h2>Usage of htmx to build the sChat application</h2>
<p>To build the application we relied on serveral libraries:</p>
<ul class="simple">
<li><a class="reference external" href="https://docs.servant.dev">Servant</a>: To build the web application (to handle routes and define
route' handlers)</li>
<li><a class="reference external" href="https://hackage.haskell.org/package/websockets">WebSockets</a>: To setup a WebSocket handler for enabling
communication between the frontend and the backend</li>
<li><a class="reference external" href="https://chrisdone.com/posts/lucid/">Lucid</a>: A DSL to render HTML</li>
<li><a class="reference external" href="https://htmx.org">htmx</a>: Run on the client's browser, to render the application</li>
<li><a class="reference external" href="https://tailwindcss.com/">Tailwindcss</a>: Run on the client's browser, to apply CSS styles</li>
</ul>
<p>But to keep this post short, we'll not dig into the usage of Servant or
Lucid but just focus on interactions between the frontend and the
backend using htmx.</p>
</div>
<div class="section" id="htmx-usage-to-build-schat">
<h2>htmx usage to build sChat</h2>
<div class="section" id="backend-http-endpoints">
<h3>Backend HTTP endpoints</h3>
<p>sChat implements three endpoints under the following routes:</p>
<ul class="simple">
<li>&quot;/&quot;: This handler returns plain HTML data. It serves a HTML bootstrap
to connect to the WebSocket.</li>
<li>&quot;xstatic&quot;: The handler serves static files. It serves htmx and
tailwindcss JS libraries</li>
<li>&quot;ws&quot;: The WebSocket handler</li>
</ul>
</div>
<div class="section" id="the-root-endpoint-1">
<span id="the-root-endpoint"></span><h3>The root &quot;/&quot; endpoint</h3>
<div class="highlight"><pre><span></span><span class="nf">sChatHTMLHandler</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">sChatHTMLHandler</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="n">doctypehtml_</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">    </span><span class="n">head_</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">      </span><span class="n">title_</span><span class="w"> </span><span class="s">&quot;Simple WebSocket Chat &quot;</span><span class="w"></span>
<span class="w">      </span><span class="n">meta_</span><span class="w"> </span><span class="p">[</span><span class="n">name_</span><span class="w"> </span><span class="s">&quot;viewport&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">content_</span><span class="w"> </span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">]</span><span class="w"></span>
<span class="w">      </span><span class="n">xstaticScripts</span><span class="w"> </span><span class="p">[</span><span class="kt">XStatic</span><span class="o">.</span><span class="n">htmx</span><span class="p">,</span><span class="w"> </span><span class="kt">XStatic</span><span class="o">.</span><span class="n">tailwind</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="n">body_</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">      </span><span class="n">div_</span><span class="w"> </span><span class="p">[</span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;container mx-auto&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">makeAttribute</span><span class="w"> </span><span class="s">&quot;hx-ws&quot;</span><span class="w"> </span><span class="s">&quot;connect:/ws&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">$</span><span class="w"></span>
<span class="w">        </span><span class="n">div_</span><span class="w"> </span><span class="p">[</span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;schat&quot;</span><span class="p">]</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
</pre></div>
<p>This function defines the HTML content to be returned to the client
after a connection on &quot;/&quot;.</p>
<p>The head includes <tt class="docutils literal">script</tt> tags to tell the browser to load htmx and
Tailwindcss.</p>
<p>The body defines a <tt class="docutils literal">div</tt> with the <tt class="docutils literal"><span class="pre">hx-ws</span></tt> attribute to tell htmx to
connect on the <tt class="docutils literal">/ws</tt> backend's endpoint. See <a class="reference external" href="https://htmx.org/attributes/hx-ws/">hx-ws</a> for details.</p>
<p>Notice the <tt class="docutils literal"><span class="pre">id=&quot;schat&quot;</span></tt> attribute, the backend will reference it to
update the client's DOM.</p>
<p>When the client's browser open sChat, the first and only thing it does
is to connect to the Web Socket.</p>
</div>
<div class="section" id="the-ws-websocket-handler">
<h3>The '/ws' WebSocket handler</h3>
<div class="highlight"><pre><span></span><span class="c1">-- This function loops until the client disconnect</span><span class="w"></span>
<span class="nf">wsChatHandler</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">SChatS</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">WS</span><span class="o">.</span><span class="kt">Connection</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Handler</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">wsChatHandler</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="n">liftIO</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">WS</span><span class="o">.</span><span class="n">withPingThread</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="n">pure</span><span class="w"> </span><span class="nb">()</span><span class="p">)</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">    </span><span class="c1">-- Send the rest of WEB UI to the client</span><span class="w"></span>
<span class="w">    </span><span class="kt">WS</span><span class="o">.</span><span class="n">sendTextData</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">renderBS</span><span class="w"> </span><span class="n">renderSChat</span><span class="w"></span>
<span class="w">    </span><span class="c1">-- Handle the client</span><span class="w"></span>
<span class="w">    </span><span class="n">handleClient</span><span class="w"></span>

<span class="c1">-- The WEB app UI</span><span class="w"></span>
<span class="nf">renderSChat</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">renderSChat</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="n">div_</span><span class="w"> </span><span class="p">[</span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;schat&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;h-auto&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">    </span><span class="n">div_</span><span class="w"> </span><span class="p">[</span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;bg-purple-100 border-4 border-purple-300 w-full h-full&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">      </span><span class="n">title</span><span class="w"></span>
<span class="w">      </span><span class="n">chatInput</span><span class="w"> </span><span class="kt">Nothing</span><span class="w"></span>
<span class="w">      </span><span class="n">chatDisplay</span><span class="w"></span>
<span class="w">      </span><span class="n">chatNotices</span><span class="w"></span>
<span class="w">  </span><span class="kr">where</span><span class="w"></span>
<span class="w">    </span><span class="n">title</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">p_</span><span class="w"> </span><span class="p">[</span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;mb-2 pb-1 bg-purple-300 text-xl&quot;</span><span class="p">]</span><span class="w"> </span><span class="s">&quot;Simple WebSocket Chat&quot;</span><span class="w"></span>
<span class="w">    </span><span class="n">chatDisplay</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">      </span><span class="n">div_</span><span class="w"> </span><span class="p">[</span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;flex flex-row space-x-2 mx-2 my-2 h-96&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">        </span><span class="n">roomChat</span><span class="w"></span>
<span class="w">        </span><span class="n">roomMembers</span><span class="w"></span>
<span class="w">      </span><span class="kr">where</span><span class="w"></span>
<span class="w">        </span><span class="n">roomChat</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">          </span><span class="n">div_</span><span class="w"> </span><span class="p">[</span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom-chat&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;flex-auto w-3/4 h-full&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">            </span><span class="n">div_</span><span class="w"></span>
<span class="w">              </span><span class="p">[</span><span class="w"> </span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom-content&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;overflow-auto border-2 border-purple-200 h-full max-h-full&quot;</span><span class="w"></span>
<span class="w">              </span><span class="p">]</span><span class="w"></span>
<span class="w">              </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="n">roomMembers</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">          </span><span class="n">div_</span><span class="w"></span>
<span class="w">            </span><span class="p">[</span><span class="w"> </span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom-members&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;overflow-auto border-2 border-purple-200 flex-auto w-1/4 h-full max-h-full&quot;</span><span class="w"></span>
<span class="w">            </span><span class="p">]</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">    </span><span class="n">chatNotices</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">      </span><span class="n">div_</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom-notices&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;overflow-auto mb-2 mx-2 border-2 border-purple-200 h-16 max-h-full&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="o">$</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>

<span class="c1">--  The chat&#39;s input field</span><span class="w"></span>
<span class="nf">chatInput</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">Text</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">chatInput</span><span class="w"> </span><span class="n">loginM</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">inputFieldName</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="n">isJust</span><span class="w"> </span><span class="n">loginM</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="s">&quot;chatInputMessage&quot;</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="s">&quot;chatInputName&quot;</span><span class="w"></span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="n">inputFieldPlaceholder</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="n">isJust</span><span class="w"> </span><span class="n">loginM</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="s">&quot;Enter a message&quot;</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="s">&quot;Enter your name&quot;</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- hx-ws attribute tells HTMX to send a payload on the WebSocket when the form is submitted</span><span class="w"></span>
<span class="w">  </span><span class="n">form_</span><span class="w"> </span><span class="p">[</span><span class="n">hxWS</span><span class="w"> </span><span class="s">&quot;send:submit&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom-input&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hxSwapOOB</span><span class="w"> </span><span class="s">&quot;innerHTML&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;mx-2 bg-purple-200 rounded-lg&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">    </span><span class="n">span_</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">      </span><span class="n">maybe</span><span class="w"> </span><span class="p">(</span><span class="n">span_</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">login</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">span_</span><span class="w"> </span><span class="p">[</span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;pl-1 pr-2&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">toHtml</span><span class="w"> </span><span class="n">login</span><span class="p">)</span><span class="w"> </span><span class="n">loginM</span><span class="w"></span>
<span class="w">      </span><span class="n">input_</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="n">type_</span><span class="w"> </span><span class="s">&quot;text&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;text-sm rounded-lg bg-purple-50 border border-purple-300 focus:border-purple-400&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="c1">-- The payload sent by HTMX can be identified via the name attribute</span><span class="w"></span>
<span class="w">          </span><span class="n">name_</span><span class="w"> </span><span class="n">inputFieldName</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom-input-field&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="n">placeholder_</span><span class="w"> </span><span class="n">inputFieldPlaceholder</span><span class="w"></span>
<span class="w">        </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="c1">-- Ensure the field got the focus</span><span class="w"></span>
<span class="w">    </span><span class="n">script_</span><span class="w"> </span><span class="s">&quot;htmx.find(&#39;#chatroom-input-field&#39;).focus()&quot;</span><span class="w"></span>
</pre></div>
<p>As soon as a new WS connection is established we enter in the
<tt class="docutils literal">wsChatHandler</tt> handler function.</p>
<p>First, <tt class="docutils literal">wsChatHandler</tt> sends the application UI as defined by
<tt class="docutils literal">renderSChat</tt> on the WS. <tt class="docutils literal">renderSchat</tt> defines the following UI
blocks:</p>
<ul class="simple">
<li>The title</li>
<li>The input field that the user will use to enter a login name and send
messages</li>
<li>The chat content block to display chat' messages</li>
<li>The notice block to display notice' messages (like user connected,
...)</li>
<li>The room members block to display connected clients</li>
</ul>
<p>Some HTML tags own an id attribute mainly for htmx to be able to <a class="reference external" href="https://htmx.org/attributes/hx-swap-oob/">swap</a>
the content based on the payload send back by the backend to the
browser.</p>
<p>Furthermore we add some Tailwindcss classes to prettify the UI.</p>
<p>Here are the first bytes received from the backend by the client over
the WS:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;schat&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;h-auto&quot;</span><span class="p">&gt;&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;bg-purple-100</span>  <span class="err">...</span>
</pre></div>
<p>As you can see, this is just plain HTML content. htmx swaps the content
of the <tt class="docutils literal">chat</tt> div on DOM by the content received from the backend. At
that point the UI on the browser is fully rendered.</p>
<div class="section" id="handling-the-client-login">
<h4>Handling the client login</h4>
<p>The <tt class="docutils literal">renderSchat</tt> function renders an <tt class="docutils literal">input</tt> field with a
<tt class="docutils literal">chatInputMessage</tt>'s name attribute. The parent's <tt class="docutils literal">form</tt>
(<tt class="docutils literal"><span class="pre">chatroom-input</span></tt>) set an attribute <tt class="docutils literal"><span class="pre">hx-ws:</span> &quot;send:submit&quot;</tt>.</p>
<p>When the <tt class="docutils literal">form</tt> is validated the following JSON payload is sent over
the WebSocket by htmx.</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;chatInputName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Fabien&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;HEADERS&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;HX-Request&quot;</span><span class="p">:</span><span class="s2">&quot;true&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;HX-Trigger&quot;</span><span class="p">:</span><span class="s2">&quot;chatroom-input&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;HX-Trigger-Name&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;HX-Target&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;HX-Current-URL&quot;</span><span class="p">:</span><span class="s2">&quot;http://127.0.0.1:8091/&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Our backend needs to react to that payload. For sChat, we need to wait
for such payload in order to validate the new client login. To do so,
the <tt class="docutils literal">waitForLoginPayload</tt> function blocks until a payload with a key
name <tt class="docutils literal">chatInputName</tt> is received on the WS. Then, the function returns
the login to the caller function.</p>
<div class="highlight"><pre><span></span><span class="nf">waitForLoginPayload</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="kt">Text</span><span class="w"></span>
<span class="nf">waitForLoginPayload</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Wait until the an input name</span><span class="w"></span>
<span class="w">  </span><span class="n">dataMessage</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">WS</span><span class="o">.</span><span class="n">receiveDataMessage</span><span class="w"> </span><span class="n">conn</span><span class="w"></span>
<span class="w">  </span><span class="kr">case</span><span class="w"> </span><span class="n">extractMessage</span><span class="w"> </span><span class="n">dataMessage</span><span class="w"> </span><span class="s">&quot;chatInputName&quot;</span><span class="w"> </span><span class="kr">of</span><span class="w"></span>
<span class="w">    </span><span class="kt">Just</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pure</span><span class="w"> </span><span class="n">login</span><span class="w"></span>
<span class="w">    </span><span class="kt">Nothing</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">waitForLoginPayload</span><span class="w"></span>

<span class="nf">extractMessage</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">WS</span><span class="o">.</span><span class="kt">DataMessage</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Text</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">Text</span><span class="w"></span>
<span class="nf">extractMessage</span><span class="w"> </span><span class="n">dataMessage</span><span class="w"> </span><span class="n">keyName</span><span class="w"> </span><span class="ow">=</span><span class="w"></span>
<span class="w">  </span><span class="kr">case</span><span class="w"> </span><span class="n">dataMessage</span><span class="w"> </span><span class="kr">of</span><span class="w"></span>
<span class="w">    </span><span class="kt">WS</span><span class="o">.</span><span class="kt">Text</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">      </span><span class="kr">case</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="o">^?</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">keyName</span><span class="w"> </span><span class="kr">of</span><span class="w"></span>
<span class="w">        </span><span class="kt">Just</span><span class="w"> </span><span class="p">(</span><span class="kt">String</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="n">m</span><span class="w"></span>
<span class="w">        </span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Nothing</span><span class="w"></span>
<span class="w">    </span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Nothing</span><span class="w"></span>
</pre></div>
<p>After the client's login we want to:</p>
<ul class="simple">
<li>refresh the input <tt class="docutils literal">form</tt></li>
<li>display the login name in front of the <tt class="docutils literal">input</tt> field</li>
<li>change the <tt class="docutils literal">input</tt> placeholder text</li>
</ul>
<p>To do that, we simply send a new <tt class="docutils literal">form</tt> (using the <tt class="docutils literal">renderInputChat</tt>
function) to the client via the WS and rely on the <a class="reference external" href="https://htmx.org/attributes/hx-swap-oob/">swap</a> feature to
get the form updated. Note that, we use a bit of Javascript to ensure
that the <tt class="docutils literal">input</tt> field get the focus.</p>
<div class="highlight"><pre><span></span><span class="w">  </span><span class="o">...</span><span class="w"></span>
<span class="w">  </span><span class="n">loginE</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">tryAny</span><span class="w"> </span><span class="n">waitForLogin</span><span class="w"></span>
<span class="w">  </span><span class="kr">case</span><span class="w"> </span><span class="n">loginE</span><span class="w"> </span><span class="kr">of</span><span class="w"></span>
<span class="w">    </span><span class="kt">Right</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">      </span><span class="c1">-- Replace the input login box with the input message box</span><span class="w"></span>
<span class="w">      </span><span class="kt">WS</span><span class="o">.</span><span class="n">sendTextData</span><span class="w"> </span><span class="n">conn</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">renderInputChat</span><span class="w"> </span><span class="n">client</span><span class="o">.</span><span class="n">cLogin</span><span class="w"></span>
<span class="w">      </span><span class="c1">-- Start handling the acknowledged client</span><span class="w"></span>
<span class="w">      </span><span class="n">handleConnected</span><span class="w"> </span><span class="n">client</span><span class="w"></span>
<span class="w">  </span><span class="o">...</span><span class="w"></span>

<span class="c1">-- Helper to render the chat&#39;s input field</span><span class="w"></span>
<span class="nf">renderInputChat</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">renderBS</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">chatInput</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">Just</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="handling-client-messages">
<h4>Handling client messages</h4>
<p>Handling messages (input and rendering) follows the same technic as of
waiting for a message input payload on the WS and updating the client
DOM via the WS.</p>
<p>After a client is 'connected', sChat starts two threads:</p>
<ul class="simple">
<li>a <tt class="docutils literal">recv</tt> thread to process any message payload appearing on the WS.</li>
<li>a <tt class="docutils literal">send</tt> thread to dispatch the right HTML payload via the WS to
the client.</li>
</ul>
<p>When a message payload appears on the WS then the <tt class="docutils literal">recv</tt> thread calls
the <tt class="docutils literal">extractMessage</tt> function and creates an <tt class="docutils literal">EMessage</tt> data that is
sent to all connected client's queue. Then the <tt class="docutils literal">send</tt> thread reads the
queue and sends back the right payload via the WS to the client.</p>
<p>The <tt class="docutils literal">EMessage</tt> is rendered using the <tt class="docutils literal">afterbegin</tt>
<a class="reference external" href="https://htmx.org/attributes/hx-swap/">swap</a> method. Which means that
we insert the response before previous <tt class="docutils literal"><span class="pre">chatroom-message</span></tt> elements.</p>
<div class="highlight"><pre><span></span><span class="o">...</span><span class="w"></span>
<span class="kr">case</span><span class="w"> </span><span class="n">extractMessage</span><span class="w"> </span><span class="n">wsD</span><span class="w"> </span><span class="s">&quot;chatInputMessage&quot;</span><span class="w"> </span><span class="kr">of</span><span class="w"></span>
<span class="w">  </span><span class="kt">Just</span><span class="w"> </span><span class="n">inputMsg</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">    </span><span class="n">now</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">getCurrentTime</span><span class="w"></span>
<span class="w">    </span><span class="n">dispatchToAll</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">EMessage</span><span class="w"> </span><span class="p">(</span><span class="kt">Message</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">myLogin</span><span class="w"> </span><span class="n">inputMsg</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kt">Nothing</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pure</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="o">...</span><span class="w"></span>
</pre></div>
<div class="highlight"><pre><span></span><span class="nf">renderMessage</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Message</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Html</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">renderMessage</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- The id and hx-swap-oob tell HTMX which elements to update in the DOM</span><span class="w"></span>
<span class="w">  </span><span class="n">div_</span><span class="w"> </span><span class="p">[</span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom-content&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hxSwapOOB</span><span class="w"> </span><span class="s">&quot;afterbegin&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">    </span><span class="n">div_</span><span class="w"> </span><span class="p">[</span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom-message&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">      </span><span class="n">span_</span><span class="w"> </span><span class="p">[</span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom-message-date&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;pr-2&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">toHtml</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">formatDate</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">date</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">span_</span><span class="w"> </span><span class="p">[</span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom-message-login&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">class_</span><span class="w"> </span><span class="s">&quot;pr-2&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">toHtml</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">unpack</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">mLogin</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">span_</span><span class="w"> </span><span class="p">[</span><span class="n">id_</span><span class="w"> </span><span class="s">&quot;chatroom-message-content&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">toHtml</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">unpack</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="w"></span>
</pre></div>
<p>We wont go over the <tt class="docutils literal"><span class="pre">chatroom-members</span></tt> and <tt class="docutils literal"><span class="pre">chat-notices</span></tt> divs
update because they are updated using the same htmx's swap technic.</p>
</div>
</div>
</div>
<div class="section" id="to-conclude">
<h2>To conclude</h2>
<p>As you can seen, using htmx and its WebSocket feature, we were able to
build a dynamic WEB UI for our chat application without the need:</p>
<ul class="simple">
<li>to build a complex REST API.</li>
<li>to write Javascript client code to perform I/O with our backend and
update the client DOM.</li>
<li>to use two different toolchains for the backend and UI.</li>
</ul>
<p>Htmx also supports regular HTTP target (GET, POST, ...) which are more
adapted for traditional WEB applications.</p>
<p>Personnaly, I feel really happy to have learnt a bit about HTMX and got
the ability to write pretty quickly decent WEB frontends for server side
applications. Next, I'll attempt to use htmx in more complex and dynamic
applications.</p>
</div>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./sprint-2024-aug-09-to-2024-aug-28-summary.html">Sprint 2024 Aug 09 to 2024 Aug 28 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jul-19-to-2024-aug-07-summary.html">Sprint 2024 Jul 19 to 2024 Aug 07 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-28-to-2024-jul-17-summary.html">Sprint 2024 Jun 28 to 2024 Jul 17 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-07-to-2024-jun-26-summary.html">Sprint 2024 Jun 07 to 2024 Jun 26 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-may-16-to-2024-jun-05-summary.html">Sprint 2024 May 16 to 2024 Jun 05 summary</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 Red Hat
           &middot; Powered by <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>
           &middot; This work is licensed under a
               <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                 Creative Commons Attribution 4.0 International License
               </a>.
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>




</body>
</html>