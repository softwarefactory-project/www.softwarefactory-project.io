<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Introducing an effects system for Monocle - Software Factory</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="./introducing-an-effects-system-for-monocle.html">

        <meta name="author" content="tristanC" />
        <meta name="description" content=".literal { border-radius: 6px; padding: 1px 1px; background-color: rgba(27,31,35,.05); } &lt;!-- This work is licensed under the Creative Commons Attribution 4.0 International License. To view a copy of this license, visit http://creativecommons.org/licenses/by/4.0/ or send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA. --&gt;This blog post explains the reasons we integrated an effect system in Monocle. This post aims to be beginner friendly. We understand that some concepts sound intimidating and we hope that this post demystifies them a bit. First …" />

        <meta property="og:site_name" content="Software Factory" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Introducing an effects system for Monocle"/>
        <meta property="og:url" content="./introducing-an-effects-system-for-monocle.html"/>
        <meta property="og:description" content=".literal { border-radius: 6px; padding: 1px 1px; background-color: rgba(27,31,35,.05); } &lt;!-- This work is licensed under the Creative Commons Attribution 4.0 International License. To view a copy of this license, visit http://creativecommons.org/licenses/by/4.0/ or send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA. --&gt;This blog post explains the reasons we integrated an effect system in Monocle. This post aims to be beginner friendly. We understand that some concepts sound intimidating and we hope that this post demystifies them a bit. First …"/>
        <meta property="article:published_time" content="2022-09-27" />
            <meta property="article:section" content="blog" />
            <meta property="article:author" content="tristanC" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/solarizedlight.css" rel="stylesheet">
        <link href="./theme/css/html4css1.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>


        <link href="./blog.xml" type="application/atom+xml" rel="alternate"
              title="Software Factory blog ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src="./images/SoftwareFactory-logo.svg" width="20px"/> Software Factory            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/contact.html">
                             Contact
                          </a></li>
                        <li class="active">
                            <a href="./category/blog.html">Blog</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./introducing-an-effects-system-for-monocle.html"
                       rel="bookmark"
                       title="Permalink to Introducing an effects system for Monocle">
                        Introducing an effects system for Monocle
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2022-09-27T00:00:00+00:00"> Tue 27 September 2022</time>
    </span>


            <span class="label label-default">By</span>
            <a href="./author/tristanc.html"><i class="fa fa-user"></i> tristanC</a>



    
</footer><!-- /.post-info -->                    </div>
                </div>
                <style type="text/css">

  .literal {
    border-radius: 6px;
    padding: 1px 1px;
    background-color: rgba(27,31,35,.05);
  }

</style><!-- This work is licensed under the Creative Commons Attribution 4.0 International License.
     To view a copy of this license, visit http://creativecommons.org/licenses/by/4.0/
     or send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.
--><p>This blog post explains the reasons we integrated an <a class="reference external" href="https://en.wikipedia.org/wiki/Effect_system">effect system</a> in
<a class="reference external" href="https://changemetrics.io/">Monocle</a>. This post aims to be beginner friendly. We understand that
some concepts sound intimidating and we hope that this post demystifies
them a bit.</p>
<p>First, it describes the context and its main issue. Next, it defines key
terms and concepts. Finally, it shows how we used the <a class="reference external" href="https://github.com/haskell-effectful/effectful#readme">effectful</a>
library to improve Monocle composability.</p>
<div class="section" id="context-and-problem-statement">
<h2>Context and problem statement</h2>
<p>Monocle components are implemented using dedicated actions. The goal is
to limit the available side-effects and to maintain a clear separation
of concerns.</p>
<p>The current implementation is based on the 'ReaderT over IO' pattern and
it is affected by a problem known as the 'n² instances'. The issue is
that adding new side-effects requires unnecessary modifications, which
limit the composability and testability of the components.</p>
</div>
<div class="section" id="what-is-a-side-effect">
<h2>What is a side-effect?</h2>
<p>A function has <a class="reference external" href="https://en.wikipedia.org/wiki/Side_effect_(computer_science)">side-effects</a> when it modifies a state outside of its
local environment. Common examples of side-effects include:</p>
<ul class="simple">
<li>Accessing the filesystem,</li>
<li>Executing another program, or</li>
<li>Connecting to a network service.</li>
</ul>
<p>In other words, a function has side-effects if its output does not
depend solely on its input. It's valuable to identify side-effects
because they require extra care when testing and optimizing.</p>
<p>The Haskell type system defines function with side-effects by wrapping
the return value in the IO action. For example, the standard 'readFile'
function is defined as <tt class="docutils literal">FilePath <span class="pre">-&gt;</span> IO String</tt>: given a file path,
'readFile' returns an IO action that produces a string.</p>
<p>Previously, in Monocle, we used the 'ReaderT over IO' pattern.</p>
</div>
<div class="section" id="what-is-a-reader">
<h2>What is a reader?</h2>
<p>A reader provides an environment to the functions. For example, instead
of passing the environment using explicit parameters:</p>
<div class="highlight"><pre><span></span><span class="nf">computeMetric</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Logger</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Database</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Param</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="kt">Metric</span><span class="w"></span>
</pre></div>
<p>A reader can declare the available environment by wrapping the return
value:</p>
<div class="highlight"><pre><span></span><span class="nf">computeMetric</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Param</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">ReaderT</span><span class="w"> </span><span class="p">(</span><span class="kt">Logger</span><span class="p">,</span><span class="w"> </span><span class="kt">Database</span><span class="p">)</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="kt">Metric</span><span class="w"></span>
</pre></div>
<p>This function signature means: given a parameter, 'computeMetric'
returns a reader action that procudes a metric using the
<tt class="docutils literal">(Logger, Database)</tt> environment. This lets us focus on the business
logic without manually handling the environment. This is particularly
convenient for intermediary functions which don't have to pass the
environment parameters around. In other words, the reader re-arranges
the function's parameters to move the environment out of the way.</p>
<p>A reader is analogous to this Python construct:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Api</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">database</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>

    <span class="k">def</span> <span class="nf">compute_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Metric</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
<p>This 'Api' object attaches the environment to a general purpose <tt class="docutils literal">self</tt>
reference which is passed on to every object method. The
<tt class="docutils literal">compute_metric</tt> method can freely read and modify the <tt class="docutils literal">self</tt>
attributes. On the other hand, the reader action precisely describes the
available environment for the <tt class="docutils literal">computeMetric</tt> function.</p>
<p>The next sections present how Monocle used to be implemented and what is
the benefit of using an effect system.</p>
</div>
<div class="section" id="monocle-action-contexts">
<h2>Monocle action contexts</h2>
<p>The Monocle component actions were defined as:</p>
<ul class="simple">
<li><tt class="docutils literal">newtype AppAction a = AppAction (ReaderT AppEnv IO a)</tt> to
initialize the index and serve the API.</li>
<li><tt class="docutils literal">newtype QueryActon a = QueryAction (ReaderT QueryEnv IO a)</tt> to
serve user metric.</li>
<li><tt class="docutils literal">newtype CrawlerAction a = CrawlerAction (ReaderT CrawlerEnv IO a)</tt>
to collect changes data.</li>
</ul>
<p>Instead of using the new types, the individual functions used mtl-style
typeclass constraints to enable generic implementations. For example
Monocle had:</p>
<ul class="simple">
<li><tt class="docutils literal">class TimeContext m</tt>, to enable reading the local time,</li>
<li><tt class="docutils literal">class RetryContext m</tt>, to catch network error and retry the action
with exponential backoff,</li>
<li><tt class="docutils literal">class LoggerContext m</tt>, to log messages, and</li>
<li><tt class="docutils literal">class DatabaseContext m</tt>, to access the database.</li>
</ul>
<p>Such typeclasses are different from Python's class: a typeclass defines
a set of methods that is shared across multiple types. This is analogous
to the Rust <a class="reference external" href="https://doc.rust-lang.org/book/ch10-02-traits.html">trait system</a>. That means each action needed to provide
its own instance, for example:</p>
<ul class="simple">
<li><tt class="docutils literal">instance DatabaseContext AppAction</tt></li>
<li><tt class="docutils literal">instance DatabaseContext QueryAction</tt></li>
</ul>
<p>Monocle also defined super constraints for the component code to avoid
listing the individual constraint:</p>
<ul class="simple">
<li><tt class="docutils literal">class (TimeContext m, LoggerContext m, DatabaseContext m) =&gt; AppContext m</tt></li>
<li><tt class="docutils literal">class (LoggerContext m, DatabaseContext m) =&gt; QueryContext m</tt></li>
<li><tt class="docutils literal">class (TimeContext m, RetryContext m) =&gt; CrawlerContext m</tt></li>
</ul>
<p>So that the <tt class="docutils literal">computeMetric</tt> function was defined as:</p>
<div class="highlight"><pre><span></span><span class="nf">computeMetric</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">QueryContext</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">Param</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="kt">Metric</span><span class="w"></span>
</pre></div>
<p>Similarly, the <tt class="docutils literal">getChanges</tt> crawler function was defined as:</p>
<div class="highlight"><pre><span></span><span class="nf">getChanges</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CrawlerContext</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">Repository</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">[</span><span class="kt">Changes</span><span class="p">]</span><span class="w"></span>
</pre></div>
<p>Pros:</p>
<ul class="simple">
<li>Restricted side effects: the function can't do arbitrary IO.</li>
<li>The constraints can be implemented differently depending on the
context.</li>
<li>The types enforce the available effects. For example, accessing the
database from a crawler context is a compile time error.</li>
</ul>
<p>Cons:</p>
<ul class="simple">
<li>Adding a new contraint requires adding new instances, the so called
'n² instances' problem.</li>
<li>This abstraction has an overhead cost, though it was not noticable in
Monocle performance.</li>
</ul>
</div>
<div class="section" id="effects-system">
<h2>Effects system</h2>
<p>To improve the Monocle code base, we replaced the mtl-style constraints
with an effect system. Instead of using constraints for the execution
context, denoted <tt class="docutils literal">m</tt>, Monocle now uses a list of effect constraints,
denoted <tt class="docutils literal">es</tt>, along with the <tt class="docutils literal">Eff</tt> action provided by the
<a class="reference external" href="https://github.com/haskell-effectful/effectful#readme">effectful</a> library.</p>
<p>The main difference is that the effect's environments are defined
individually, and we no longer have to implement the <tt class="docutils literal">m</tt> constraint
for every context. Effectful effectively lets us easily compose a list
of readers. To learn more about this technique, checkout the
<a class="reference external" href="https://hackage.haskell.org/package/effectful-core-2.1.0.0/docs/Effectful-Dispatch-Static.html">Effectful.Dispatch.Static</a> module documentation.</p>
<p>We replaced the super contexts with a type alias to list all the
necessary effects in one place:</p>
<ul class="simple">
<li><tt class="docutils literal">type QueryEffects es = [LoggerEffect,DatabaseEffect] :&gt;&gt; es</tt></li>
<li><tt class="docutils literal">type CrawlerEffects es = [TimeEffect,RetryEffect] :&gt;&gt; es</tt></li>
</ul>
<p>And the <tt class="docutils literal">computeMetric</tt> and <tt class="docutils literal">getChanges</tt> functions are now defined
as:</p>
<div class="highlight"><pre><span></span><span class="nf">computeMetric</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">QueryEffects</span><span class="w"> </span><span class="n">es</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">Param</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Eff</span><span class="w"> </span><span class="n">es</span><span class="w"> </span><span class="kt">Metric</span><span class="w"></span>
<span class="nf">getChanges</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CrawlerEffects</span><span class="w"> </span><span class="n">es</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="kt">Repository</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Eff</span><span class="w"> </span><span class="n">es</span><span class="w"> </span><span class="p">[</span><span class="kt">Changes</span><span class="p">]</span><span class="w"></span>
</pre></div>
<p>The initial refactor aimed for a drop-in replacement so that only the
function's signature changed from <tt class="docutils literal">m</tt> to <tt class="docutils literal">Eff es</tt>. If you are
curious, you can check the <a class="reference external" href="https://github.com/change-metrics/monocle/pull/954">PR#954</a> which introduced the new
implementation.</p>
<p>Pros:</p>
<ul class="simple">
<li>This new implementation is arguably simpler: an effect is defined
only once.</li>
<li>Effectful enables seamless integration with the existing Haskell
ecosystem.</li>
<li>Eff is fast: the effect lookup is <tt class="docutils literal">O(1)</tt> according to its
<a class="reference external" href="https://hackage.haskell.org/package/effectful-core-2.1.0.0/docs/Effectful-Internal-Effect.html#t:Effect">documentation</a>.</li>
</ul>
<p>Cons:</p>
<ul class="simple">
<li>The effectful library is relatively new and the ecosystem is still
immature.</li>
<li>The Eff implementation is more complicated than a simple Reader, for
example the process known as <a class="reference external" href="https://github.com/fpco/unliftio#unlifting-in-2-minutes">unlifting</a> requires extra attentions
when running concurrently.</li>
</ul>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>We are satisfied with the transition and we are looking forward to
contributing to the effectful ecosystem by sharing the Monocle
implementations.</p>
<p>Please note that behind the 'Action' and 'Context' mentioned in this
post, there is a fundamental structure called a <a class="reference external" href="https://en.wikipedia.org/wiki/Monad_(functional_programming)">Monad</a>. If you are not
familiar with the concept already, we recommend this <a class="reference external" href="https://www.youtube.com/watch?v=t1e8gqXLbsU">computerphile
video</a> by Graham Hutton.</p>
<p>Thanks for reading!</p>
</div>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./sprint-2024-aug-09-to-2024-aug-28-summary.html">Sprint 2024 Aug 09 to 2024 Aug 28 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jul-19-to-2024-aug-07-summary.html">Sprint 2024 Jul 19 to 2024 Aug 07 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-28-to-2024-jul-17-summary.html">Sprint 2024 Jun 28 to 2024 Jul 17 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-07-to-2024-jun-26-summary.html">Sprint 2024 Jun 07 to 2024 Jun 26 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-may-16-to-2024-jun-05-summary.html">Sprint 2024 May 16 to 2024 Jun 05 summary</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 Red Hat
           &middot; Powered by <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>
           &middot; This work is licensed under a
               <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                 Creative Commons Attribution 4.0 International License
               </a>.
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>




</body>
</html>