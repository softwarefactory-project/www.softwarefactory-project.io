

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Operate zuul &mdash; software-factory  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="software-factory  documentation" href="../index.html"/>
        <link rel="up" title="Management" href="management.html"/>
        <link rel="next" title="Operate nodepool" href="nodepool_operator.html"/>
        <link rel="prev" title="Authentication" href="auths.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> software-factory
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../components/index.html">Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">User documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Operator documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quickstart.html">Quick Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="deployment.html">Deploy Software Factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="management.html">Management</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="auths.html">Authentication</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Operate zuul</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#jobs-default-nodeset">Jobs default nodeset</a></li>
<li class="toctree-l4"><a class="reference internal" href="#save-and-restore-the-queues">Save and restore the queues</a></li>
<li class="toctree-l4"><a class="reference internal" href="#restart-zuul-services">Restart Zuul services</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configure-an-external-gerrit-use-software-factory-as-a-third-party-ci">Configure an external gerrit (use Software Factory as a Third-Party CI)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-a-git-connection">Add a git connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-a-github-app">Create a GitHub app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#use-openstack-infra-zuul-jobs">Use openstack-infra/zuul-jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#restarting-a-config-update-job">Restarting a config-update job</a></li>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting-non-starting-jobs">Troubleshooting non starting jobs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#troubleshooting-the-executor">Troubleshooting the executor</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="nodepool_operator.html">Operate nodepool</a></li>
<li class="toctree-l3"><a class="reference internal" href="gerritbot_operator.html">Configure gerritbot for IRC notification</a></li>
<li class="toctree-l3"><a class="reference internal" href="firehose_operator.html">Embedded MQTT broker</a></li>
<li class="toctree-l3"><a class="reference internal" href="gerrit_replication_operator.html">Gerrit GIT repositories replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="repoxplorer.html">RepoXplorer service to browse hosted projects stats</a></li>
<li class="toctree-l3"><a class="reference internal" href="elk_operator.html">ELK service</a></li>
<li class="toctree-l3"><a class="reference internal" href="log_classify_operator.html">Log Classify Operator</a></li>
<li class="toctree-l3"><a class="reference internal" href="access_control.html">Access control</a></li>
<li class="toctree-l3"><a class="reference internal" href="metrics.html">System and Services metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="code_search.html">Source code search engine</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrade.html">Upgrade Software Factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="backup_restore.html">Backup restore</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="deepdive.html">Internals</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributor/index.html">Contributor documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs/index.html">Frequently Asked Questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">software-factory</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Operator documentation</a> &raquo;</li>
        
          <li><a href="management.html">Management</a> &raquo;</li>
        
      <li>Operate zuul</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/operator/zuul_operator.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is a lightweight documentation intended to get operators started with setting
up the Zuul service. For more insight on what Zuul can do, please refer
to upstream <a class="reference external" href="https://docs.openstack.org/infra/zuul/">documentation</a>.</p>
</div>
<div class="section" id="operate-zuul">
<h1>Operate zuul<a class="headerlink" href="#operate-zuul" title="Permalink to this headline">¶</a></h1>
<p>The Zuul service is installed with rh-python35 software collections:</p>
<ul class="simple">
<li>The configuration is located in /etc/zuul</li>
<li>The logs are written to /var/log/zuul</li>
<li>The services are prefixed with rh-python35-</li>
</ul>
<p>A convenient wrapper for the command line is installed in /usr/bin/zuul.</p>
<p>By default, no merger are being deployed because the executor service
can perform merge task. However, a merger can also be deployed to speed
up start time when there are many projects defined.</p>
<div class="section" id="jobs-default-nodeset">
<h2>Jobs default nodeset<a class="headerlink" href="#jobs-default-nodeset" title="Permalink to this headline">¶</a></h2>
<p>The default configuration in <em>/etc/software-factory/sfconfig.yaml</em> for zuul
nodeset is to use the label <em>runc-centos</em>. This label is only available if you
added the role <em>hypervisor-runc</em> in <em>/etc/software-factory/arch.yaml</em>. If you
don’t use this role, you should specify the nodeset to use for jobs. For
example, if you have defined a dib image in nodepool configuration, you should
update <em>/etc/software-factory/sfconfig.yaml</em> to specify the default nodeset name
and label, for instance:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">zuul</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">default_nodeset_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dib-centos-7</span>
  <span class="l l-Scalar l-Scalar-Plain">default_nodeset_label</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dib-centos-7</span>
</pre></div>
</div>
<p>Then, run <a class="reference internal" href="configuration.html#configure-reconfigure"><span class="std std-ref">sfconfig</span></a> to apply the modification</p>
</div>
<div class="section" id="save-and-restore-the-queues">
<h2>Save and restore the queues<a class="headerlink" href="#save-and-restore-the-queues" title="Permalink to this headline">¶</a></h2>
<p>The zuul scheduler service is stateless and stopping the process will lose track
of running jobs. However the zuul-changes.py utility can be used
to save and restore the current state:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Print and save all builds in progress to /var/lib/zuul/zuul-queues-dump.sh</span>
/usr/libexec/software-factory/zuul-changes.py dump

systemctl restart rh-python35-zuul-scheduler

<span class="c1"># Reload the previous state</span>
/usr/libexec/software-factory/zuul-changes.py load
</pre></div>
</div>
<p>The periodic and post pipelines are not dumped by this tool.</p>
</div>
<div class="section" id="restart-zuul-services">
<span id="id1"></span><h2>Restart Zuul services<a class="headerlink" href="#restart-zuul-services" title="Permalink to this headline">¶</a></h2>
<p>The <em>zuul_restart.yml</em> playbook stops and restarts Zuul services and
automatically restore the scheduler’s jobs queues.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">ansible-playbook /var/lib/software-factory/ansible/zuul_restart.yml</span>
</pre></div>
</div>
</div>
<div class="section" id="configure-an-external-gerrit-use-software-factory-as-a-third-party-ci">
<h2>Configure an external gerrit (use Software Factory as a Third-Party CI)<a class="headerlink" href="#configure-an-external-gerrit-use-software-factory-as-a-third-party-ci" title="Permalink to this headline">¶</a></h2>
<p>Refer to the <a class="reference internal" href="quickstart.html#tpci-quickstart"><span class="std std-ref">Third-Party-CI Quick Start guide</span></a></p>
</div>
<div class="section" id="add-a-git-connection">
<span id="zuul-github-app-operator"></span><h2>Add a git connection<a class="headerlink" href="#add-a-git-connection" title="Permalink to this headline">¶</a></h2>
<p>In /etc/software-factory/sfconfig.yaml add in <em>git_connections</em>:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gerrithub</span>
  <span class="l l-Scalar l-Scalar-Plain">baseurl</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://review.gerrithub.io</span>
</pre></div>
</div>
<p>Then run <strong>sfconfig</strong> to apply the configuration.</p>
</div>
<div class="section" id="create-a-github-app">
<h2>Create a GitHub app<a class="headerlink" href="#create-a-github-app" title="Permalink to this headline">¶</a></h2>
<p>To create a GitHub app on my-org follow this
<a class="reference external" href="https://developer.github.com/apps/building-integrations/setting-up-and-registering-github-apps/registering-github-apps/">github documentation</a>:</p>
<ul class="simple">
<li>Open the App creation form:<ul>
<li>to create the app under an organization, go to <cite>https://github.com/organizations/&lt;organization&gt;/settings/apps/new</cite></li>
<li>to create the app under a user account, go to <cite>https://github.com/settings/apps/new</cite></li>
</ul>
</li>
<li>Set GitHub App name to “my-org-zuul”</li>
<li>Set Homepage URL to “<a class="reference external" href="https://fqdn">https://fqdn</a>”</li>
<li>Set Setup URL to “<a class="reference external" href="https://fqdn/docs/user/zuul_user.html">https://fqdn/docs/user/zuul_user.html</a>”</li>
<li>Set Webhook URL to “<a class="reference external" href="https://fqdn/zuul/api/connection/github.com/payload">https://fqdn/zuul/api/connection/github.com/payload</a>”</li>
<li>Create a Webhook secret</li>
<li>Set permissions:<ul>
<li>Repository Administraion: Read (get branch protection status)</li>
<li>Repository contents: Read &amp; Write (write to let zuul merge change)</li>
<li>Issues: Read &amp; Write</li>
<li>Pull requests: Read &amp; Write</li>
<li>Commit statuses: Read &amp; Write</li>
</ul>
</li>
<li>Set events subscription:<ul>
<li>Commit comment</li>
<li>Create</li>
<li>Push</li>
<li>Release</li>
<li>Issue comment</li>
<li>Issues</li>
<li>Label</li>
<li>Pull request</li>
<li>Pull request review</li>
<li>Pull request review comment</li>
<li>Status</li>
</ul>
</li>
<li>Set Where can this GitHub App be installed to “Any account”</li>
<li>Create the App</li>
<li>In the ‘General’ tab generate a Private key for your application, and download the key to a secure location</li>
</ul>
<p>To configure the Github connection in sfconfig.yaml, add to the <strong>github_connections</strong> section:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;github.com&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">webhook_token</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">XXXX</span> <span class="c1"># The Webhook secret defined earlier</span>
  <span class="l l-Scalar l-Scalar-Plain">app_id</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">42</span> <span class="c1"># The ID shown in the about section of the app.</span>
  <span class="l l-Scalar l-Scalar-Plain">app_key</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/software-factory/github.key</span> <span class="c1"># Path to the private key generated during the setup of the app.</span>
  <span class="l l-Scalar l-Scalar-Plain">app_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">app-name</span>
  <span class="l l-Scalar l-Scalar-Plain">label_name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mergeit</span> <span class="c1"># Label of the tag that must be set to let Zuul trigger the gate pipeline.</span>
</pre></div>
</div>
<p>Then run <strong>sfconfig</strong> to apply the configuration. And finally verify in the ‘Advanced’
tab that the Ping payload works (green tick and 200 response). Click “Redeliver” if needed.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It’s recommended to use a GitHub app instead of manual webhook. When using
manual webhook, set the api_token instead of the app_id and app_key.
Manual webhook documentation is still TBD…</p>
</div>
<p>Check out the <a class="reference internal" href="../user/zuul_user.html#zuul-github-app-user"><span class="std std-ref">Zuul GitHub App user documentation</span></a> to start using the application.</p>
<p>More information about the Zuul’s Github driver can be found in the Zuul Github driver <a class="reference external" href="https://docs.openstack.org/infra/zuul/admin/drivers/github.html">manual</a>.</p>
</div>
<div class="section" id="use-openstack-infra-zuul-jobs">
<h2>Use openstack-infra/zuul-jobs<a class="headerlink" href="#use-openstack-infra-zuul-jobs" title="Permalink to this headline">¶</a></h2>
<p>The zuul-scheduler can automatically import all the jobs defined in
the zuul-ci.org/zuul-jobs repository. Set the zuul.upstream_zuul_jobs options
to True in sfconfig.yaml</p>
</div>
<div class="section" id="restarting-a-config-update-job">
<span id="restart-config-update"></span><h2>Restarting a config-update job<a class="headerlink" href="#restarting-a-config-update-job" title="Permalink to this headline">¶</a></h2>
<p>When the <em>config-update</em> job fails, you can manually restart the job using
the command bellow. Make sure to set the <em>ref-sha</em> which is the last commit
hash of the config repository.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>zuul enqueue-ref --trigger gerrit --tenant <span class="nb">local</span> --pipeline post --project config --ref master --newrev ref-sha
</pre></div>
</div>
<p>The job will be running in the post pipeline of the Zuul status page.</p>
</div>
<div class="section" id="troubleshooting-non-starting-jobs">
<h2>Troubleshooting non starting jobs<a class="headerlink" href="#troubleshooting-non-starting-jobs" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>First check that the project is defined in /etc/opt/rh/rh-python35/zuul/main.yaml</li>
<li>Then check in scheduler.log that it correctly requested a node and submitted a
job to the executor</li>
<li>When zuul reports <em>PRE_FAILURE</em> or <em>POST_FAILURE</em>,
then the executor’s debugging needs to be turned on</li>
<li>Finally passing all loggers’ level to DEBUG in
/etc/opt/rh/rh-python35/zuul/scheduler-logging.yaml then restarting the service
rh-python35-zuul-scheduler might help to debug.</li>
</ul>
</div>
<div class="section" id="troubleshooting-the-executor">
<h2>Troubleshooting the executor<a class="headerlink" href="#troubleshooting-the-executor" title="Permalink to this headline">¶</a></h2>
<p>First you need to enable the executor’s <em>keepjob</em> option so that ansible logs are available on dist:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>/opt/rh/rh-python35/root/bin/zuul-executor keep
/opt/rh/rh-python35/root/bin/zuul-executor verbose
</pre></div>
</div>
<p>Then next job execution will be available in /tmp/systemd-private-<em>-rh-python35-zuul-executor.service-</em>/tmp/</p>
<p>In particular, the work/ansible/job-logs.txt usually tells why a job failed.</p>
<p>When done with debugging, deactivate the keepjob option by running:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>/opt/rh/rh-python35/root/bin/zuul-executor nokeep
/opt/rh/rh-python35/root/bin/zuul-executor unverbose
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="nodepool_operator.html" class="btn btn-neutral float-right" title="Operate nodepool" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="auths.html" class="btn btn-neutral" title="Authentication" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, Red Hat.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>