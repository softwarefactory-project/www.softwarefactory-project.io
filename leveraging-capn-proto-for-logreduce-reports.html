<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Leveraging Cap'n Proto For Logreduce Reports - Software Factory</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="./leveraging-capn-proto-for-logreduce-reports.html">

        <meta name="author" content="tristanC" />
        <meta name="description" content="blockquote { font-size: small; padding: 0px 5px; } &lt;!-- This work is licensed under the Creative Commons Attribution 4.0 International License. To view a copy of this license, visit http://creativecommons.org/licenses/by/4.0/ or send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA. --&gt; This post is a follow-up on the previous WASM based web interface article. This post describes why and how I used Cap’n Proto for the logreduce reports format. In three parts, I present: Bincode versioning scheme. Cap’n Proto. Logreduce report encoder/decoder …" />

        <meta property="og:site_name" content="Software Factory" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Leveraging Cap&#39;n Proto For Logreduce Reports"/>
        <meta property="og:url" content="./leveraging-capn-proto-for-logreduce-reports.html"/>
        <meta property="og:description" content="blockquote { font-size: small; padding: 0px 5px; } &lt;!-- This work is licensed under the Creative Commons Attribution 4.0 International License. To view a copy of this license, visit http://creativecommons.org/licenses/by/4.0/ or send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA. --&gt; This post is a follow-up on the previous WASM based web interface article. This post describes why and how I used Cap’n Proto for the logreduce reports format. In three parts, I present: Bincode versioning scheme. Cap’n Proto. Logreduce report encoder/decoder …"/>
        <meta property="article:published_time" content="2023-10-23" />
            <meta property="article:section" content="blog" />
            <meta property="article:author" content="tristanC" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/solarizedlight.css" rel="stylesheet">
        <link href="./theme/css/html4css1.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>


        <link href="./blog.xml" type="application/atom+xml" rel="alternate"
              title="Software Factory blog ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src="./images/SoftwareFactory-logo.svg" width="20px"/> Software Factory            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/contact.html">
                             Contact
                          </a></li>
                        <li class="active">
                            <a href="./category/blog.html">Blog</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./leveraging-capn-proto-for-logreduce-reports.html"
                       rel="bookmark"
                       title="Permalink to Leveraging Cap'n Proto For Logreduce Reports">
                        Leveraging Cap'n Proto For Logreduce Reports
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2023-10-23T00:00:00+00:00"> Mon 23 October 2023</time>
    </span>


            <span class="label label-default">By</span>
            <a href="./author/tristanc.html"><i class="fa fa-user"></i> tristanC</a>



    
</footer><!-- /.post-info -->                    </div>
                </div>
                <style type="text/css">
  blockquote {
    font-size: small;
    padding: 0px 5px;
  }
</style><!-- This work is licensed under the Creative Commons Attribution 4.0 International License.
     To view a copy of this license, visit http://creativecommons.org/licenses/by/4.0/
     or send a letter to Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.
--><!--  -->
<blockquote>
This post is a follow-up on the previous <a class="reference external" href="https://www.softwarefactory-project.io/logreduce-wasm-based-web-interface.html">WASM based web interface</a>
article.</blockquote>
<p>This post describes why and how I used <a class="reference external" href="https://capnproto.org/">Cap’n Proto</a> for the
<a class="reference external" href="https://github.com/logreduce/logreduce#readme">logreduce</a> reports format. In three parts, I present:</p>
<ul class="simple">
<li>Bincode versioning scheme.</li>
<li>Cap’n Proto.</li>
<li>Logreduce report encoder/decoder.</li>
</ul>
<div class="section" id="context-and-problem-statement">
<h2>Context and problem statement</h2>
<p>Logreduce is a tool that searches for anomalies in build logs. It can
produce reports displayable on web browsers. Logreduce used to
distribute an HTML file setup with a compatible rendering client.
However, in the context of the new web service interface, the client may
now display reports that were created by an older version of logreduce.</p>
<p>The problem is that the report format didn't guarantee backward
compatibility: clients were not able to read reports saved in a previous
version.</p>
<p>I evaluated the following formats to solve this problem:</p>
<ul class="simple">
<li><a class="reference external" href="https://protobuf.dev/">Protobuf</a>, introduced by Google in 2001.</li>
<li><a class="reference external" href="https://thrift.apache.org/">Thrift</a>, introduced by Facebook in 2007.</li>
<li><a class="reference external" href="https://capnproto.org/">Cap’n Proto</a>, introduced by the former maintainer of Protobuf in
2013.</li>
<li><a class="reference external" href="https://flatbuffers.dev/">Flatbuffers</a>, introduced by Google in 2014.</li>
</ul>
<p>Cap'n Proto and Flatbuffers are modern formats designed for
performance-critical applications. They both enable access to the data
without parsing/unpacking, using a process known as zero-copy
serialization, which is a great feature for logreduce. Flatbuffers was
originally created for games development and it doesn't perform data
validation by default. Therefore I decided to use Cap'n Proto as
discussed in the next sections.</p>
</div>
<div class="section" id="bincode-versioning-scheme">
<h2>Bincode versioning scheme</h2>
<p>In this section I present the main challenge of using bincode to save
data. Previously, logreduce used bincode to exchange reports.</p>
<div class="section" id="prepare-the-playground">
<h3>Prepare the playground</h3>
<p>For the purpose of this article, we'll create a standalone playground.</p>
<blockquote>
If you don't have <tt class="docutils literal">cargo</tt>, see this <a class="reference external" href="https://www.rust-lang.org/tools/install">install rust</a> documentation.</blockquote>
<p>Setup a new project:</p>
<div class="highlight"><pre><span></span>$ cargo new capnp-playground
$ cd capnp-playground
</pre></div>
<p>Add dependencies:</p>
<div class="highlight"><pre><span></span>$ cargo add bincode@1.3
</pre></div>
<p>Add serde with the derive feature to generate the encoder/decoder:</p>
<div class="highlight"><pre><span></span>$ cargo add serde@1.0 --features derive
</pre></div>
<p>And build everything:</p>
<div class="highlight"><pre><span></span>$ cargo run
Hello, world!
</pre></div>
</div>
<div class="section" id="create-the-initial-report">
<h3>Create the initial report</h3>
<p>Add the following code to demonstrate bincode usage in the
<tt class="docutils literal">src/main.rs</tt> file:</p>
<div class="highlight"><pre><span></span><span class="c1">// Copyright (C) 2023 Red Hat</span>
<span class="c1">// SPDX-License-Identifier: Apache-2.0</span>

<span class="c1">// This program demonstrates data type serialization.</span>
<span class="c1">// It does not handle exceptions and unwrap is used to keep the code short.</span>

<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">fs</span>::<span class="n">File</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[derive(Debug, Serialize, Deserialize)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">Report</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">baselines</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Content</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="c1">// list of anomaly omitted</span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Debug, Serialize, Deserialize)]</span><span class="w"></span>
<span class="k">enum</span> <span class="nc">Content</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Zuul</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">change</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">job</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">Prow</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">pr</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">url</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">encode</span><span class="p">(</span><span class="n">report</span>: <span class="kp">&amp;</span><span class="nc">Report</span><span class="p">,</span><span class="w"> </span><span class="n">file</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}: saving report&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">create</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">bincode</span>::<span class="n">serialize_into</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">report</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">decode</span><span class="p">(</span><span class="n">file</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Report</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}: loading report&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">File</span>::<span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">bincode</span>::<span class="n">deserialize_from</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="o">&amp;</span><span class="n">std</span>::<span class="n">env</span>::<span class="n">args</span><span class="p">().</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">()[</span><span class="o">..</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;encode&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Report</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">baselines</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="n">Content</span>::<span class="n">Zuul</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">change</span>: <span class="mi">42</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">job</span>: <span class="s">&quot;test&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<span class="w">                </span><span class="p">}],</span><span class="w"></span>
<span class="w">            </span><span class="p">};</span><span class="w"></span>
<span class="w">            </span><span class="n">encode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">report</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;decode&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decode</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;got: {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">report</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">&quot;usage: encode|decode file&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Run the following commands to perform a serialization round trip:</p>
<div class="highlight"><pre><span></span>$ cargo run -- encode report.bin
report.bin: saving report

$ cargo run -- decode report.bin
report.bin: loading report
got: Report { baselines: [Zuul { change: 42, job: &quot;test&quot; }] }
</pre></div>
</div>
<div class="section" id="updating-the-schema">
<h3>Updating the schema</h3>
<p>Update the schema, for example, by adding a new field to the Zuul
structure:</p>
<div class="highlight"><pre><span></span><span class="gd">--- a/src/main.rs</span><span class="w"></span>
<span class="gi">+++ b/src/main.rs</span><span class="w"></span>
<span class="gu">@@ -14,6 +14,7 @@ enum Content {</span><span class="w"></span>
<span class="w"> </span>    Zuul {<span class="w"></span>
<span class="w"> </span>        change: u64,<span class="w"></span>
<span class="w"> </span>        job: String,<span class="w"></span>
<span class="gi">+        project: String,</span><span class="w"></span>
<span class="w"> </span>    },<span class="w"></span>
<span class="w"> </span>    Prow {<span class="w"></span>
<span class="w"> </span>        pr: u64,<span class="w"></span>

<span class="gu">@@ -38,6 +38,7 @@ fn main() {</span><span class="w"></span>
<span class="w"> </span>                baselines: vec![Content::Zuul {<span class="w"></span>
<span class="w"> </span>                    change: 42,<span class="w"></span>
<span class="w"> </span>                    job: &quot;test&quot;.to_string(),<span class="w"></span>
<span class="gi">+                    project: &quot;demo&quot;.to_string(),</span><span class="w"></span>
<span class="w"> </span>                }],<span class="w"></span>
<span class="w"> </span>            };<span class="w"></span>
<span class="w"> </span>            encode(&amp;report, fp);<span class="w"></span>
</pre></div>
<p>Now, decoding the initial report produces this error:</p>
<div class="highlight"><pre><span></span>$ cargo run -- decode report.bin
report.bin: loading report
thread &#39;main&#39; panicked at src/main.rs:42:37:
called `Result::unwrap()` on an `Err` value: Io(Error {
  kind: UnexpectedEof,
  message: &quot;failed to fill whole buffer&quot;
})
</pre></div>
<p>That is expected: bincode is not able to deserialize the previous report
because it now expects that Zuul builds have a project. To address that,
we need to use a versioning scheme, for example with such a data type:</p>
<div class="highlight"><pre><span></span><span class="k">enum</span> <span class="nc">Report</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">V1</span><span class="p">(</span><span class="n">ReportV1</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="n">V2</span><span class="p">(</span><span class="n">ReportV2</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>As long as we only append new variants, bincode is able to decode
reports saved in a previous version. However this is not very practical
because any change will introduce a new top level version.</p>
<p>Moreover, bincode doesn't check the enum tag. If we move the <tt class="docutils literal">Prow</tt>
variant at the top of the <tt class="docutils literal">Content</tt> declaration, then bincode will
happily load the report using the wrong tag because the existing data
fits the shape.</p>
<p>In the next section, I introduce a different format to handle versioning
efficiently.</p>
</div>
</div>
<div class="section" id="introducing-capn-proto">
<h2>Introducing Cap’n Proto</h2>
<p>Cap’n Proto is a fast data interchange format. The main benefits are:</p>
<ul class="simple">
<li>strongly-typed schema with first class support for <a class="reference external" href="https://en.wikipedia.org/wiki/Algebraic_data_type">algebraic data
types</a> and generic types.</li>
<li>backward compatible message.</li>
<li>zero-copy serialization.</li>
</ul>
<div class="section" id="schema-language">
<h3>Schema Language</h3>
<p>The data format is defined using a special language. Here is the schema
for the report used in the playground above, copy this to a file named
<tt class="docutils literal">schema.capnp</tt> at the root of the project:</p>
<div class="highlight"><pre><span></span><span class="nd">@0xa0b4401e03756e61</span>;<span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="n">Report</span><span class="w"> </span>{<span class="w"></span>
<span class="w">  </span><span class="n">baselines</span><span class="w"> </span><span class="nd">@0</span><span class="w"> </span><span class="nc">:List(Content)</span>;<span class="w"></span>
}<span class="w"></span>

<span class="k">struct</span><span class="w"> </span><span class="n">Content</span><span class="w"> </span>{<span class="w"></span>
<span class="w">  </span><span class="k">union</span><span class="w"> </span>{<span class="w"></span>
<span class="w">    </span><span class="n">zuul</span><span class="w">    </span><span class="nd">@0</span><span class="w"> </span><span class="nc">:Zuul</span>;<span class="w"></span>
<span class="w">    </span><span class="n">prow</span><span class="w">    </span><span class="nd">@1</span><span class="w"> </span><span class="nc">:Prow</span>;<span class="w"></span>
<span class="w">  </span>}<span class="w"></span>

<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="n">Zuul</span><span class="w"> </span>{<span class="w"></span>
<span class="w">    </span><span class="n">change</span><span class="w">  </span><span class="nd">@0</span><span class="w"> </span><span class="nc">:UInt64</span>;<span class="w"></span>
<span class="w">    </span><span class="n">job</span><span class="w">     </span><span class="nd">@1</span><span class="w"> </span><span class="nc">:Text</span>;<span class="w"></span>
<span class="w">    </span><span class="n">project</span><span class="w"> </span><span class="nd">@2</span><span class="w"> </span><span class="nc">:Text</span>;<span class="w"></span>
<span class="w">  </span>}<span class="w"></span>

<span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="n">Prow</span><span class="w"> </span>{<span class="w"></span>
<span class="w">    </span><span class="n">pr</span><span class="w">      </span><span class="nd">@0</span><span class="w"> </span><span class="nc">:UInt64</span>;<span class="w"></span>
<span class="w">    </span><span class="n">url</span><span class="w">     </span><span class="nd">@1</span><span class="w"> </span><span class="nc">:Text</span>;<span class="w"></span>
<span class="w">  </span>}<span class="w"></span>
}<span class="w"></span>
</pre></div>
<p>This should be self explanatory. Checkout the full logreduce report
schema in this <a class="reference external" href="https://github.com/logreduce/logreduce/blob/main/crates/report/schema.capnp">report/schema.capnp</a>, and the <a class="reference external" href="https://capnproto.org/language.html">language documentation</a>
to learn more about it.</p>
</div>
<div class="section" id="code-generation">
<h3>Code generation</h3>
<p>Cap'n Proto provides a compiler named <tt class="docutils literal">capnpc</tt> to generate code for
<a class="reference external" href="https://capnproto.org/otherlang.html">various languages</a>. Copy the following build instructions to a file
named <tt class="docutils literal">build.rs</tt> at the root of the project:</p>
<div class="highlight"><pre><span></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">capnpc</span>::<span class="n">CompilerCommand</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">file</span><span class="p">(</span><span class="s">&quot;schema.capnp&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">output_path</span><span class="p">(</span><span class="s">&quot;generated/&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">run</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;compiling schema.capnp&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Get the compiler by installing <tt class="docutils literal">capnproto</tt> using your favorite package
manager, then run the following commands to generate the code:</p>
<div class="highlight"><pre><span></span>$ cargo add --build capnpc@0.18 &amp;&amp; cargo add capnp@0.18
$ cargo build
</pre></div>
<p>Integrate the generated code in the <tt class="docutils literal">main.rs</tt> file by adding:</p>
<div class="highlight"><pre><span></span><span class="k">mod</span> <span class="nn">schema_capnp</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cp">#![allow(dead_code, unused_qualifications)]</span><span class="w"></span>
<span class="w">    </span><span class="fm">include!</span><span class="p">(</span><span class="s">&quot;../generated/schema_capnp.rs&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>This setup introduces new Reader and Builder data types to read and
write reports according to the schema definition.</p>
<p>In the next section I show how to use the new data types.</p>
</div>
</div>
<div class="section" id="report-encoder-decoder">
<h2>Report Encoder/Decoder</h2>
<p>As an example usage of the generated data types, we can implement an
encoder/decoder for the existing report struct.</p>
<div class="section" id="encode-a-report">
<h3>Encode a report</h3>
<p>Here is how to write a report using the <tt class="docutils literal"><span class="pre">capnp::message</span></tt> module:</p>
<div class="highlight"><pre><span></span><span class="c1">// This function write the report to the argument implementing the Write trait.</span>
<span class="k">fn</span> <span class="nf">capnp_encode</span><span class="p">(</span><span class="n">report</span>: <span class="kp">&amp;</span><span class="nc">Report</span><span class="p">,</span><span class="w"> </span><span class="n">write</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">capnp</span>::<span class="n">io</span>::<span class="n">Write</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Prepare a report message builder</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">capnp</span>::<span class="n">message</span>::<span class="n">Builder</span>::<span class="n">new_default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">report_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="n">init_root</span>::<span class="o">&lt;</span><span class="n">schema_capnp</span>::<span class="n">report</span>::<span class="n">Builder</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Write a single content.</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">write_content</span><span class="p">(</span><span class="n">content</span>: <span class="kp">&amp;</span><span class="nc">Content</span><span class="p">,</span><span class="w"> </span><span class="n">builder</span>: <span class="nc">schema_capnp</span>::<span class="n">content</span>::<span class="n">Builder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">content</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Content</span>::<span class="n">Zuul</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">change</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">job</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">project</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Prepare a zuul builder.</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">init_zuul</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Write the fields</span>
<span class="w">                </span><span class="n">builder</span><span class="p">.</span><span class="n">set_change</span><span class="p">(</span><span class="o">*</span><span class="n">change</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">builder</span><span class="p">.</span><span class="n">set_job</span><span class="p">(</span><span class="n">job</span><span class="p">.</span><span class="n">as_str</span><span class="p">().</span><span class="n">into</span><span class="p">());</span><span class="w"></span>
<span class="w">                </span><span class="n">builder</span><span class="p">.</span><span class="n">set_project</span><span class="p">(</span><span class="n">project</span><span class="p">.</span><span class="n">as_str</span><span class="p">().</span><span class="n">into</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">Content</span>::<span class="n">Prow</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pr</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Prepare a prow builder.</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">init_prow</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Write the fields</span>
<span class="w">                </span><span class="n">builder</span><span class="p">.</span><span class="n">set_pr</span><span class="p">(</span><span class="o">*</span><span class="n">pr</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">builder</span><span class="p">.</span><span class="n">set_url</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">as_str</span><span class="p">().</span><span class="n">into</span><span class="p">());</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Write the baselines vector</span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Prepare the list builder.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">baselines_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">report_builder</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">reborrow</span><span class="p">()</span><span class="w"></span>
<span class="w">            </span><span class="p">.</span><span class="n">init_baselines</span><span class="p">(</span><span class="n">report</span><span class="p">.</span><span class="n">baselines</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">content</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">report</span><span class="p">.</span><span class="n">baselines</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Prepare the list element builder.</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">content_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">baselines_builder</span><span class="p">.</span><span class="n">reborrow</span><span class="p">().</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="c1">// Write the individual baseline.</span>
<span class="w">            </span><span class="n">write_content</span><span class="p">(</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">content_builder</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Write the message</span>
<span class="w">    </span><span class="n">capnp</span>::<span class="n">serialize</span>::<span class="n">write_message</span><span class="p">(</span><span class="n">write</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">message</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Update the encode helper:</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -29,7 +84,7 @@ enum Content {</span><span class="w"></span>
<span class="w"> </span>fn encode(report: &amp;Report, file: &amp;str) {<span class="w"></span>
<span class="w"> </span>    println!(&quot;{}: saving report&quot;, file);<span class="w"></span>
<span class="w"> </span>    let file = File::create(file).unwrap();<span class="w"></span>
<span class="gd">-    bincode::serialize_into(file, report).unwrap();</span><span class="w"></span>
<span class="gi">+    capnp_encode(report, file)</span><span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
</pre></div>
<p>Run the following command to demonstrate the encoding:</p>
<div class="highlight"><pre><span></span>$ cargo run -- encode report.msg
report.msg: saving report
</pre></div>
</div>
<div class="section" id="decode-a-report">
<h3>Decode a report</h3>
<p>Here is how to read a report:</p>
<div class="highlight"><pre><span></span><span class="c1">// This function read the report from the argument implementing the BufRead trait.</span>
<span class="k">fn</span> <span class="nf">capnp_decode</span><span class="p">(</span><span class="n">bufread</span>: <span class="nc">impl</span><span class="w"> </span><span class="n">capnp</span>::<span class="n">io</span>::<span class="n">BufRead</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Report</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">message_reader</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">        </span><span class="n">capnp</span>::<span class="n">serialize</span>::<span class="n">read_message</span><span class="p">(</span><span class="n">bufread</span><span class="p">,</span><span class="w"> </span><span class="n">capnp</span>::<span class="n">message</span>::<span class="n">ReaderOptions</span>::<span class="n">new</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">report_reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message_reader</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_root</span>::<span class="o">&lt;</span><span class="n">schema_capnp</span>::<span class="n">report</span>::<span class="n">Reader</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">read_content</span><span class="p">(</span><span class="n">reader</span>: <span class="kp">&amp;</span><span class="nc">schema_capnp</span>::<span class="n">content</span>::<span class="n">Reader</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Content</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">use</span><span class="w"> </span><span class="n">schema_capnp</span>::<span class="n">content</span>::<span class="n">Which</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Read the generated union data type</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">which</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">Which</span>::<span class="n">Zuul</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Prepare the reader</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Read the fields</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">get_change</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">get_job</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">to_str</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">into</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">get_project</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">to_str</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">into</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="n">Content</span>::<span class="n">Zuul</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                    </span><span class="n">change</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">job</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">project</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="n">Which</span>::<span class="n">Prow</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Prepare the reader</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="c1">// Read the fields</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">pr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">get_pr</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">get_url</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">to_str</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">into</span><span class="p">();</span><span class="w"></span>
<span class="w">                </span><span class="n">Content</span>::<span class="n">Prow</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pr</span><span class="p">,</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Read the baselines vector</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">baselines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Prepare the reader</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">report_reader</span><span class="p">.</span><span class="n">get_baselines</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Read the baselines</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">with_capacity</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">reader</span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">vec</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">read_content</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reader</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">vec</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">Report</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">baselines</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<p>Update the decode helper:</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -90,7 +142,7 @@ fn encode(report: &amp;Report, file: &amp;str) {</span><span class="w"></span>
<span class="w"> </span>fn decode(file: &amp;str) -&gt; Report {<span class="w"></span>
<span class="w"> </span>    println!(&quot;{}: loading report&quot;, file);<span class="w"></span>
<span class="w"> </span>    let file = File::open(file).unwrap();<span class="w"></span>
<span class="gd">-    bincode::deserialize_from(file).unwrap()</span><span class="w"></span>
<span class="gi">+    capnp_decode(std::io::BufReader::new(file))</span><span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
</pre></div>
<p>Run the following command to demonstrate the decoding:</p>
<div class="highlight"><pre><span></span>$ cargo run -- decode report.msg
report.msg: loading report
got: Report { baselines: [Zuul { change: 42, job: &quot;test&quot;, project: &quot;demo&quot; }] }
</pre></div>
<p>This concludes the serialization round trip demonstration using Cap'n
Proto. In the next section I show how to update the schema.</p>
</div>
<div class="section" id="evolving-the-schema">
<h3>Evolving the schema</h3>
<p>In this section, we'll perform a schema update like we did earlier.</p>
<p>Cap'n Proto prescribes a list of rules to preserve backward compability.
For example, it is not possible to remove fields, they can only be
marked as obsolete, and their memory location will always be reserved.</p>
<p>It is of course possible to add new fields. For example, here is how to
add a title field to the report struct:</p>
<div class="highlight"><pre><span></span><span class="gh">diff --git a/schema.capnp b/schema.capnp</span><span class="w"></span>
<span class="gh">index add50b9..cd9e996 100644</span><span class="w"></span>
<span class="gd">--- a/schema.capnp</span><span class="w"></span>
<span class="gi">+++ b/schema.capnp</span><span class="w"></span>
<span class="gu">@@ -2,6 +2,7 @@</span><span class="w"></span>

<span class="w"> </span>struct Report {<span class="w"></span>
<span class="w"> </span>  baselines @0 :List(Content);<span class="w"></span>
<span class="gi">+  title     @1 :Text;</span><span class="w"></span>
<span class="w"> </span>}<span class="w"></span>

<span class="gh">diff --git a/src/main.rs b/src/main.rs</span><span class="w"></span>
<span class="gh">index 09fc740..40411ad 100644</span><span class="w"></span>
<span class="gd">--- a/src/main.rs</span><span class="w"></span>
<span class="gi">+++ b/src/main.rs</span><span class="w"></span>
<span class="gu">@@ -15,6 +15,7 @@</span><span class="w"></span>
<span class="w"> </span>#[derive(Debug, Serialize, Deserialize)]<span class="w"></span>
<span class="w"> </span>struct Report {<span class="w"></span>
<span class="w"> </span>    baselines: Vec&lt;Content&gt;,<span class="w"></span>
<span class="gi">+    title: String,</span><span class="w"></span>
<span class="w"> </span>    // list of anomaly omitted<span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
<span class="gu">@@ -58,6 +58,8 @@ fn capnp_encode(report: &amp;Report, write: impl capnp::io::Write) {</span><span class="w"></span>
<span class="w"> </span>        }<span class="w"></span>
<span class="w"> </span>    }<span class="w"></span>

<span class="gi">+    report_builder.set_title(report.title.as_str().into());</span><span class="w"></span>

<span class="w"> </span>    // Write the message<span class="w"></span>
<span class="w"> </span>    capnp::serialize::write_message(write, &amp;message).unwrap();<span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
<span class="gu">@@ -111,12 +113,15 @@ fn capnp_decode(bufread: impl capnp::io::BufRead) -&gt; Report {</span><span class="w"></span>
<span class="w"> </span>        vec<span class="w"></span>
<span class="w"> </span>    };<span class="w"></span>

<span class="gd">-    Report { baselines }</span><span class="w"></span>
<span class="gi">+    let title = report_reader.get_title().unwrap().to_str().unwrap().into();</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    Report { baselines, title }</span><span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
<span class="gu">@@ -149,6 +154,7 @@ fn main() {</span><span class="w"></span>
<span class="w"> </span>    match &amp;std::env::args().collect::&lt;Vec&lt;_&gt;&gt;()[..] {<span class="w"></span>
<span class="w"> </span>        [_, cmd, fp] if cmd == &quot;encode&quot; =&gt; {<span class="w"></span>
<span class="w"> </span>            let report = Report {<span class="w"></span>
<span class="gi">+                title: &quot;test title&quot;.to_string(),</span><span class="w"></span>
<span class="w"> </span>                baselines: vec![Content::Zuul {<span class="w"></span>
<span class="w"> </span>                    change: 42,<span class="w"></span>
<span class="w"> </span>                    job: &quot;test&quot;.to_string(),<span class="w"></span>
</pre></div>
<p>Run this command to demonstrate we can read the report previously saved:</p>
<div class="highlight"><pre><span></span>$ cargo run -- decode ./report.msg
report.msg: loading report
got: Report { baselines: [Zuul { change: 42, job: &quot;test&quot;, project: &quot;demo&quot; }], title: &quot;&quot; }
</pre></div>
<p>The decoding succeeded and the report title field got the default value.</p>
</div>
</div>
<div class="section" id="benchmark">
<h2>Benchmark</h2>
<p>In this section, I measure the performance of Cap'n Proto using a sample
report of 1k lines with 2k lines of context.</p>
<div class="section" id="cpu-usage">
<h3>CPU usage</h3>
<p>Here are the results of the <a class="reference external" href="https://github.com/logreduce/logreduce/blob/main/crates/report/benches/bench-report.rs">benchmark</a> running on my thinkpad t14
laptop:</p>
<div class="highlight"><pre><span></span>$ cargo bench # lower is better
Decoder/capnp           time:   [296.55 µs 297.00 µs 297.45 µs]
Decoder/bincode         time:   [278.36 µs 279.11 µs 280.01 µs]
Decoder/json            time:   [954.06 µs 956.90 µs 961.04 µs]

Encoder/capnp           time:   [71.704 µs 71.773 µs 71.875 µs]
Encoder/bincode         time:   [26.368 µs 26.394 µs 26.425 µs]
Encoder/json            time:   [162.20 µs 162.33 µs 162.46 µs]

Read/capnp              time:   [0.1119 µs 0.1120 µs 0.1129 µs]
Read/bincode            time:   [294.48 µs 295.36 µs 296.59 µs]
Read/json               time:   [987.78 µs 990.39 µs 995.78 µs]
</pre></div>
<p>Note that this is a simple benchmark, and I may have missed some
optimizations, though the results match the public <a class="reference external" href="https://github.com/djkoloski/rust_serialization_benchmark">rust serialization
benchmark</a>.</p>
<p>The encoder/decoder benchmark loads the full report struct. Cap'n Proto
encoder/decoder are a bit slower because they perform extra validation
work to protect against malicious input (see <a class="reference external" href="https://capnproto.org/encoding.html#security-considerations">security
considerations</a>).</p>
<p>The read benchmark traverses the report to count the number of lines. In
that case, Cap'n Proto is three orders of magnitude faster because we
can access the data directly from the reading buffer, without perfoming
any copy. This is great for rendering in the browser, because the dom
elements need to copy the data anyway, so we can avoid decoding the
report into an intermediary structure. Here is how the read benchmark is
implemented:</p>
<div class="highlight"><pre><span></span><span class="n">group</span><span class="p">.</span><span class="n">bench_function</span><span class="p">(</span><span class="s">&quot;capnp&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Create a message reader</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">slice</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">black_box</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoded_capnp</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">message_reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">capnp</span>::<span class="n">serialize</span>::<span class="n">read_message_from_flat_slice</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">slice</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">capnp</span>::<span class="n">message</span>::<span class="n">ReaderOptions</span>::<span class="n">new</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message_reader</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_root</span>::<span class="o">&lt;</span><span class="n">logreduce_report</span>::<span class="n">schema_capnp</span>::<span class="n">report</span>::<span class="n">Reader</span><span class="o">&lt;&#39;</span><span class="nb">_</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Traverse the list of log reports</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reader</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">get_log_reports</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">fold</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">lr</span><span class="o">|</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lr</span><span class="p">.</span><span class="n">get_anomalies</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">len</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="mi">1025</span><span class="p">);</span><span class="w"></span>
<span class="p">}));</span><span class="w"></span>

<span class="n">group</span><span class="p">.</span><span class="n">bench_function</span><span class="p">(</span><span class="s">&quot;bincode&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">slice</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">black_box</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoded_bincode</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">report</span>: <span class="nc">Report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bincode</span>::<span class="n">deserialize_from</span><span class="p">(</span><span class="n">slice</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">report</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">log_reports</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">fold</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">lr</span><span class="o">|</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lr</span><span class="p">.</span><span class="n">anomalies</span><span class="p">.</span><span class="n">len</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="mi">1025</span><span class="p">)</span><span class="w"></span>
<span class="p">}));</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="report-file-size-1">
<span id="report-file-size"></span><h3>Report file size.</h3>
<p>Cap'n Proto wire format is a bit heavier and after compression, about
12% bigger than bincode:</p>
<div class="highlight"><pre><span></span>$ du -b report*
162824  report-capnp.bin
114360  report-capnp-packed.bin
123916  report-bincode.bin
149830  report.json

$ gzip report*; du -b report*
59361   report-capnp.bin.gz
61280   report-capnp-packed.bin.gz
52435   report-bincode.bin.gz
50401   report.json.gz
</pre></div>
<p>Note that Cap'n Proto also supports a packed format, but it has higher
runtime costs and worse gzip compressions.</p>
<p>It is surprising that compression works so well on JSON for this schema.
I guess this is because the report is mostly a list of list of text with
few structure fields.</p>
</div>
<div class="section" id="client-code-size">
<h3>Client code size</h3>
<p>Lastly the runtime code is similar, here is the WASM size before and
after the <a class="reference external" href="https://github.com/logreduce/logreduce/pull/57">PR introducing capnp</a>:</p>
<div class="highlight"><pre><span></span>$ nix build -o capnp   github:logreduce/logreduce/fb4f69e#web
$ nix build -o bincode github:logreduce/logreduce/2578019#web
$ du -b capnp/*.wasm bincode/*.wasm
529322  capnp/logreduce-web.wasm
531327  bincode/logreduce-web.wasm
</pre></div>
<p>I guess the runtime code is smaller because capnp does not use the serde
machinery.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Cap'n Proto works well for logreduce. The schema language is simple to
understand and the generated code is easy to work with. Being able to
read the data directly from memory is a great capability that can enable
blazingly fast processing.</p>
<p>Writing the encoder and decoder is a bit of fairly mechanical work.
However doing this work manually enables adding customization, for
example, deduplicating the data using a process known as <a class="reference external" href="https://en.wikipedia.org/wiki/String_interning">string
interning</a>. Future work in rust introspection may enable deriving this
work automatically, checkout the <a class="reference external" href="https://soasis.org/posts/a-mirror-for-rust-a-plan-for-generic-compile-time-introspection-in-rust/">Shepherd’s Oasis blog post</a> to learn
more.</p>
<p>In conclusion, replacing bincode with Cap'n Proto future proofs
logreduce reports. This format adds some negligible storage and
processing costs, in exchange for a backward compatible schema and more
efficient data access. Flatbuffers is also worth considering as it has a
lower storage cost, but it requires more work to verify that the data is
safe to be processed.</p>
</div>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./sprint-2024-aug-09-to-2024-aug-28-summary.html">Sprint 2024 Aug 09 to 2024 Aug 28 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jul-19-to-2024-aug-07-summary.html">Sprint 2024 Jul 19 to 2024 Aug 07 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-28-to-2024-jul-17-summary.html">Sprint 2024 Jun 28 to 2024 Jul 17 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-07-to-2024-jun-26-summary.html">Sprint 2024 Jun 07 to 2024 Jun 26 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-may-16-to-2024-jun-05-summary.html">Sprint 2024 May 16 to 2024 Jun 05 summary</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 Red Hat
           &middot; Powered by <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>
           &middot; This work is licensed under a
               <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                 Creative Commons Attribution 4.0 International License
               </a>.
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>




</body>
</html>