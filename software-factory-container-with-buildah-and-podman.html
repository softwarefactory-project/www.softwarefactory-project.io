<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Software Factory Container With Buildah And Podman - Software Factory</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="./software-factory-container-with-buildah-and-podman.html">

        <meta name="author" content="tristanC" />
        <meta name="description" content="This article explains how to run Software Factory in a container with Buildah and Podman. Containerize Software Factory We are planning on supporting Software Factory deployment on OKD in the future, however, we are waiting for a proper cloud-native Zuul service to mitigate the executor root privilege requirements discussed in …" />

        <meta property="og:site_name" content="Software Factory" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Software Factory Container With Buildah And Podman"/>
        <meta property="og:url" content="./software-factory-container-with-buildah-and-podman.html"/>
        <meta property="og:description" content="This article explains how to run Software Factory in a container with Buildah and Podman. Containerize Software Factory We are planning on supporting Software Factory deployment on OKD in the future, however, we are waiting for a proper cloud-native Zuul service to mitigate the executor root privilege requirements discussed in …"/>
        <meta property="article:published_time" content="2019-01-02" />
            <meta property="article:section" content="blog" />
            <meta property="article:author" content="tristanC" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/solarizedlight.css" rel="stylesheet">
        <link href="./theme/css/html4css1.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>


        <link href="./blog.xml" type="application/atom+xml" rel="alternate"
              title="Software Factory blog ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src="./images/SoftwareFactory-logo.svg" width="20px"/> Software Factory            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/contact.html">
                             Contact
                          </a></li>
                        <li class="active">
                            <a href="./category/blog.html">Blog</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./software-factory-container-with-buildah-and-podman.html"
                       rel="bookmark"
                       title="Permalink to Software Factory Container With Buildah And Podman">
                        Software Factory Container With Buildah And Podman
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2019-01-02T00:00:00+00:00"> Wed 02 January 2019</time>
    </span>


            <span class="label label-default">By</span>
            <a href="./author/tristanc.html"><i class="fa fa-user"></i> tristanC</a>



    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>This article explains how to run Software Factory in a container with
<a class="reference external" href="https://buildah.io/">Buildah</a> and <a class="reference external" href="https://podman.io/">Podman</a>.</p>
<div class="section" id="containerize-software-factory">
<h2>Containerize Software Factory</h2>
<p>We are planning on supporting Software Factory deployment on <a class="reference external" href="https://www.okd.io/">OKD</a> in the
future, however, we are waiting for a proper cloud-native Zuul service to
mitigate the executor root privilege requirements discussed in this <a class="reference external" href="http://lists.zuul-ci.org/pipermail/zuul-discuss/2018-July/000477.html">thread</a>.</p>
<p>This article is about containerizing the current Software Factory architecture
<strong>as-is</strong>:</p>
<ul class="simple">
<li>Using the sfconfig Ansible playbook to install and configure the services,</li>
<li>Managing the services with systemd, and</li>
<li>Deploying all in one container.</li>
</ul>
<p>Our goal is to enable the user to quickly prototype and easily deploy the
services on a personal computer.</p>
</div>
<div class="section" id="building-the-image-with-buildah">
<h2>Building The Image With Buildah</h2>
<p><a class="reference external" href="https://buildah.io/">Buildah</a> is a tool that facilitates building <a class="reference external" href="https://www.opencontainers.org">Open Container Initiative</a> (OCI)
compliant images. Here is the bulk of the image building process:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -e</span>
<span class="nv">container</span><span class="o">=</span><span class="k">$(</span>buildah from centos:latest<span class="k">)</span>
<span class="nv">mountpath</span><span class="o">=</span><span class="k">$(</span>buildah mount <span class="nv">$container</span><span class="k">)</span>

<span class="nb">trap</span> <span class="s2">&quot;set +e; buildah umount </span><span class="nv">$container</span><span class="s2">; buildah delete </span><span class="nv">$container</span><span class="s2">&quot;</span> EXIT

<span class="c1"># Install sfconfig</span>
buildah run <span class="nv">$container</span> -- yum install -y <span class="se">\</span>
  https://softwarefactory-project.io/repos/sf-release-master.rpm
buildah run <span class="nv">$container</span> -- yum install -y sf-config

<span class="c1"># Run the install playbook</span>
buildah run <span class="nv">$container</span> -- sfconfig --skip-setup

<span class="c1"># Test that zuul is installed</span>
buildah run <span class="nv">$container</span> -- scl <span class="nb">enable</span> rh-python35 -- zuul --version
<span class="c1"># -&gt; Zuul version: 3.3.1-1.el7</span>

<span class="c1"># Tag the image</span>
buildah config --created-by <span class="s2">&quot;Software Factory&quot;</span> <span class="nv">$container</span>
buildah config --author <span class="s2">&quot;release@softwarefactory-project.io&quot;</span> <span class="nv">$container</span>

buildah commit <span class="nv">$container</span> sf-image
</pre></div>
<p>The main advantage of this method is its flexibility. The final <strong>commit</strong>
command creates a single layer and the <strong>mountpath</strong> variable enables
direct access to the image content.
Iterating quickly to fix the few issues found when using sf-config inside a
container image (such as fixing SELinux configuration which is not authorized
in a container) has been invaluable.</p>
<p>Here are some useful buildah commands:</p>
<ul class="simple">
<li>List the containers used: <em>buildah containers</em></li>
<li>Cleanup stalled build: <em>buildah delete --all</em></li>
<li>Cleanup images: <em>buildah rmi -a</em></li>
</ul>
<p>We now have an OCI image with all the Software Factory package installed but
they are not configured yet.</p>
</div>
<div class="section" id="starting-systemd-inside-a-container">
<h2>Starting Systemd Inside A Container</h2>
<p>The recommended strategy is to run one service per container. However,
this requires an orchestration engine and adds some networking and
storage complexicity.</p>
<p>To keep things as simple as possible, we are going to start systemd inside
the container.</p>
<p>First we create a new minimal systemd target without multi-user services
such as agetty:</p>
<div class="highlight"><pre><span></span># /etc/systemd/system/default.target
[Unit]
Description=Software Factory boot target
Requires=basic.target network.target network-online.target
Wants=sfconfig.service
After=basic.target
</pre></div>
<p>Then we create a new sfconfig service to trigger the configuration playbook:</p>
<div class="highlight"><pre><span></span># /lib/systemd/system/sfconfig.service
[Unit]
Description=sfconfig configuration script
Requires=dbus.service sshd.service

[Service]
Type=simple
ExecStart=/usr/libexec/software-factory/sfinit
TimeoutSec=0
StandardOutput=tty
StandardError=tty
StandardInput=tty
TTYPath=/dev/pts/0
TTYReset=yes
TTYVHangup=yes
</pre></div>
<p>And finally we create a <strong>sfinit</strong> script to manage the services configuration
and execute a journalctl process so that services logs are forwarded to the
container logs:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash -i</span>
<span class="c1"># prettify env</span>
<span class="nb">export</span> <span class="nv">HOME</span><span class="o">=</span>/root
<span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm
<span class="nb">source</span> /etc/profile

<span class="c1"># fix hostname (hostnamectl doesn&#39;t work in podman)</span>
hostname managesf.sfpodman.local
sed -e <span class="s1">&#39;s/sftests.com/sfpodman.local/&#39;</span> -i /etc/software-factory/sfconfig.yaml
cat <span class="s">&lt;&lt;EOF&gt; /etc/software-factory/custom-vars.yaml</span>
<span class="s">provision_demo: true</span>
<span class="s">gateway_force_ssl_redirection: false</span>
<span class="s">EOF</span>

<span class="c1"># enable exec in /tmp (TODO: figure out what set it to noexec...)</span>
mount -o remount,exec /tmp

<span class="c1"># setup services</span>
sfconfig --skip-install
journalctl -f <span class="p">&amp;</span>
<span class="nb">exec</span> bash
</pre></div>
<p>The above file needs to be added inside the <em>mountpath</em> and sfinit needs to be
marked executable. We can now finalize the image creation:</p>
<div class="highlight"><pre><span></span><span class="c1"># Run these before the commit command</span>
buildah config --cmd /sbin/init <span class="nv">$container</span>
builadh config --port <span class="m">80</span>        <span class="nv">$container</span>
builadh config --port <span class="m">443</span>       <span class="nv">$container</span>
builadh config --port <span class="m">29418</span>     <span class="nv">$container</span>
</pre></div>
<p>And test it using this command:</p>
<img alt="None" src="images/systemd-podman.jpg" />
<div class="line-block">
<div class="line"><br /></div>
</div>
</div>
<div class="section" id="running-the-image-with-podman">
<h2>Running The Image With Podman</h2>
<p><a class="reference external" href="https://podman.io/">Podman</a> is a container runtime that does not implement a big fat daemon like
the Docker Engine. The advantage of the <a class="reference external" href="https://podman.io/">Podman</a> model is that cgroups or
security constraints still control the container processes.</p>
<p>To start software factory:</p>
<div class="highlight"><pre><span></span>$ podman run --privileged --interactive --tty --publish-all
             --systemd --name my-sf sf-image
<span class="o">[</span>...<span class="o">]</span>
PLAY RECAP ********************************************************************
managesf.sfpodman.local    : <span class="nv">ok</span><span class="o">=</span><span class="m">528</span>  <span class="nv">changed</span><span class="o">=</span><span class="m">252</span>  <span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span>    <span class="nv">failed</span><span class="o">=</span><span class="m">0</span>

Friday <span class="m">04</span> January <span class="m">2019</span>  <span class="m">10</span>:15:29 +0000 <span class="o">(</span><span class="m">0</span>:00:00.071<span class="o">)</span>       <span class="m">0</span>:03:07.513 ********
<span class="o">===============================================================================</span>
sf-mysql : Start mariadb ----------------------------------------------- <span class="m">12</span>.13s
sf-gerrit : Start service ----------------------------------------------- <span class="m">9</span>.37s
sf-gerrit : Reload gerrit service --------------------------------------- <span class="m">8</span>.70s
sf-gerrit : restart gerrit ---------------------------------------------- <span class="m">8</span>.64s
sf-gateway : Update dashboards ------------------------------------------ <span class="m">6</span>.14s
sf-zuul : Get service configuration via managesf/configurations --------- <span class="m">5</span>.98s
sf-repos : Check <span class="k">if</span> repository exists ----------------------------------- <span class="m">5</span>.16s
sf-repos : Check <span class="k">if</span> repository exists ----------------------------------- <span class="m">5</span>.12s
sf-zuul : Generate tenant-update secrets -------------------------------- <span class="m">5</span>.03s
sf-repos : Check <span class="k">if</span> repository exists ----------------------------------- <span class="m">3</span>.92s
sf-repos : Create initial resources ------------------------------------- <span class="m">3</span>.88s
sf-gerrit : Reindex gerrit when service is not running ------------------ <span class="m">3</span>.86s
sf-gerrit : Initialize/Upgrade gerrit when service is not running ------- <span class="m">3</span>.73s
sf-repos : Provision demo resources <span class="k">in</span> config repo ---------------------- <span class="m">2</span>.78s
sf-zuul : Wait <span class="k">for</span> gearman server --------------------------------------- <span class="m">2</span>.09s
sf-zuul : Manually create database to avoid concurrency issue ----------- <span class="m">1</span>.98s
sf-postfix : Generate virtual database ---------------------------------- <span class="m">1</span>.90s
sf-monit : restart monit ------------------------------------------------ <span class="m">1</span>.86s
sf-monit : restart monit ------------------------------------------------ <span class="m">1</span>.82s
sf-repos : Make a first admin connexion through SF SSO ------------------ <span class="m">1</span>.64s
sfpodman.local: SUCCESS

Access dashboard: https://sfpodman.local
Login with admin user, get the admin password by running:
  awk <span class="s1">&#39;/admin_password/ {print $2}&#39;</span> /etc/software-factory/sfconfig.yaml
</pre></div>
<ul class="simple">
<li>The <em>--privileged</em> flag is required for the zuul-executor services.</li>
<li>The <em>--interactive</em> and <em>--tty</em> (or simply <em>-ti</em>) flags keep the process
in the foreground.</li>
<li>The <em>--publish-all</em> flag creates the network port mapping.</li>
<li>The <em>--systemd</em> flag take cares of special configurations needed by the
systemd init command.</li>
<li>And the <em>--name</em> flag is to name the container for easy reference.</li>
</ul>
<p>After the configuration is completed, you can set the ip address of the
instance to <strong>sfpodman.local</strong> in your /etc/hosts file and use this
command to get the port mapping:</p>
<div class="highlight"><pre><span></span>$ podman port my-sf
<span class="m">443</span>/tcp -&gt; <span class="m">0</span>.0.0.0:33251
<span class="m">80</span>/tcp -&gt; <span class="m">0</span>.0.0.0:38087
<span class="m">29418</span>/tcp -&gt; <span class="m">0</span>.0.0.0:36167
</pre></div>
<p>After using the services, you can save the state to restart the container with
your change using:</p>
<div class="highlight"><pre><span></span>$ podman commit my-sf my-sf-image
// Then use my-sf-image instead of sf-image
</pre></div>
<p>Finally you can publish the image to a remote registry using:</p>
<div class="highlight"><pre><span></span>$ podman login docker.io
$ podman push sf-image docker://docker.io/my-org/sf-image
</pre></div>
<p>Here are some other useful podman commands:</p>
<ul class="simple">
<li>List available images: <em>podman images</em></li>
<li>List processes: <em>podman ps -a</em></li>
<li>Kill all the containers: <em>podman rm -af</em></li>
<li>Cleanup images: <em>podman rmi -a</em></li>
</ul>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Using <a class="reference external" href="https://podman.io/">Podman</a> and <a class="reference external" href="https://buildah.io/">Buildah</a>, we can build a Software Factory container image that is
surprisingly small, less than <strong>500 MB</strong> and fast to deploy, about: <strong>5 minutes</strong>.
Check it for yourself using this single command:</p>
<div class="highlight"><pre><span></span>$ podman run --privileged --interactive --tty --publish-all --systemd softwarefactoryproject/sf-minimal:latest
</pre></div>
<p>Similarly, we can also build the other Software Factory architectures, for example
the sf-zuul-minimal which doesn't have the gerrit service and the sf-allinone
which features all the supported services such as InfluxDB, Grafana, ELK, lodgeit,
etherpad, mumble, code-search, repoxplorer and storyboard:</p>
<div class="highlight"><pre><span></span>$ podman run --privileged --interactive --tty --publish-all --systemd softwarefactoryproject/sf-allinone:latest
</pre></div>
<img alt="None" src="images/podman-allinone.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>It is worthy to mention that <a class="reference external" href="https://podman.io/">Podman</a>, <a class="reference external" href="https://buildah.io/">Buildah</a> and other tools like
<a class="reference external" href="https://github.com/containers/skopeo">Skopeo</a> or <a class="reference external" href="https://cri-o.io/">CRI-O</a> re-use common data libraries that support multiple
independent processes to interact with at the same time:
<a class="reference external" href="https://github.com/containers/storage">containers/storage</a> and <a class="reference external" href="https://github.com/containers/image">containers/image</a>.</p>
<p>Altogether, this new toolchain offers an efficient method to work with
open containers without the hassle of frequent docker issues.</p>
<p>Moreover, the maintainers are very re-active: when working on this story,
I encountered a bug with the commit command which got promptly fixed in
<a class="reference external" href="https://github.com/containers/libpod/issues/2066">less that 4 hours</a>.</p>
</div>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./sprint-2024-aug-09-to-2024-aug-28-summary.html">Sprint 2024 Aug 09 to 2024 Aug 28 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jul-19-to-2024-aug-07-summary.html">Sprint 2024 Jul 19 to 2024 Aug 07 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-28-to-2024-jul-17-summary.html">Sprint 2024 Jun 28 to 2024 Jul 17 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-07-to-2024-jun-26-summary.html">Sprint 2024 Jun 07 to 2024 Jun 26 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-may-16-to-2024-jun-05-summary.html">Sprint 2024 May 16 to 2024 Jun 05 summary</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 Red Hat
           &middot; Powered by <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>
           &middot; This work is licensed under a
               <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                 Creative Commons Attribution 4.0 International License
               </a>.
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>




</body>
</html>