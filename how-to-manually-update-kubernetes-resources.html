<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>How to manually update Kubernetes Resources - Software Factory</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="./how-to-manually-update-kubernetes-resources.html">

        <meta name="author" content="tristanC" />
        <meta name="description" content="This article demonstrates different strategies to update kubernetes resources. Context and Problem Statement Our goal is to update resource without overwritting changes made outside of our control. For example, we would like to upgrade a container image version or a deployment replicas count. In the context of a kubernetes operator …" />

        <meta property="og:site_name" content="Software Factory" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="How to manually update Kubernetes Resources"/>
        <meta property="og:url" content="./how-to-manually-update-kubernetes-resources.html"/>
        <meta property="og:description" content="This article demonstrates different strategies to update kubernetes resources. Context and Problem Statement Our goal is to update resource without overwritting changes made outside of our control. For example, we would like to upgrade a container image version or a deployment replicas count. In the context of a kubernetes operator …"/>
        <meta property="article:published_time" content="2022-07-15" />
            <meta property="article:section" content="blog" />
            <meta property="article:author" content="tristanC" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/solarizedlight.css" rel="stylesheet">
        <link href="./theme/css/html4css1.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>


        <link href="./blog.xml" type="application/atom+xml" rel="alternate"
              title="Software Factory blog ATOM Feed"/>
</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src="./images/SoftwareFactory-logo.svg" width="20px"/> Software Factory            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/contact.html">
                             Contact
                          </a></li>
                        <li class="active">
                            <a href="./category/blog.html">Blog</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./how-to-manually-update-kubernetes-resources.html"
                       rel="bookmark"
                       title="Permalink to How to manually update Kubernetes Resources">
                        How to manually update Kubernetes Resources
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2022-07-15T00:00:00+00:00"> Fri 15 July 2022</time>
    </span>


            <span class="label label-default">By</span>
            <a href="./author/tristanc.html"><i class="fa fa-user"></i> tristanC</a>



    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>This article demonstrates different strategies to update kubernetes resources.</p>
<div class="section" id="context-and-problem-statement">
<h2>Context and Problem Statement</h2>
<p>Our goal is to update resource without overwritting changes made outside of our control.
For example, we would like to upgrade a container image version or a deployment replicas count.</p>
<p>In the context of a kubernetes operator, there are two forms of resource update: <em>replace</em> and <em>patch</em>.
To demonstrate how the update process works, we'll use the API directly by starting a proxy:</p>
<div class="highlight"><pre><span></span>kubectl proxy --port<span class="o">=</span><span class="m">8080</span>
</pre></div>
</div>
<div class="section" id="resource-version">
<h2>Resource Version</h2>
<p>Each resource is assigned a version number in its metadata.
In this example, we create a deployment named <em>demo-deployment</em> in the namespace <em>tristanc</em>:</p>
<div class="highlight"><pre><span></span>curl -XPOST -H <span class="s2">&quot;Content-Type: application/json&quot;</span> http://localhost:8080/apis/apps/v1/namespaces/tristanc/deployments --data-binary @- <span class="s">&lt;&lt;EOF</span>
<span class="s">{</span>
<span class="s">  &quot;metadata&quot;: {&quot;name&quot;: &quot;demo-deployment&quot;},</span>
<span class="s">  &quot;spec&quot;: {</span>
<span class="s">    &quot;replicas&quot;: 1,</span>
<span class="s">    &quot;selector&quot;: {&quot;matchLabels&quot;: {&quot;app&quot;: &quot;demo&quot;}},</span>
<span class="s">    &quot;template&quot;: {</span>
<span class="s">      &quot;metadata&quot;: {&quot;labels&quot;: {&quot;app&quot;: &quot;demo&quot;}},</span>
<span class="s">      &quot;spec&quot;: {</span>
<span class="s">        &quot;containers&quot;: [{</span>
<span class="s">            &quot;name&quot;: &quot;container-1&quot;</span>
<span class="s">            &quot;args&quot;: [&quot;sleep&quot;, &quot;infinity&quot;],</span>
<span class="s">            &quot;image&quot;: &quot;registry.fedoraproject.org/fedora:latest&quot;,</span>
<span class="s">            &quot;imagePullPolicy&quot;: &quot;IfNotPresent&quot;,</span>
<span class="s">        }]</span>
<span class="s">      }</span>
<span class="s">    }</span>
<span class="s">  }</span>
<span class="s">}</span>
<span class="s">EOF</span>
</pre></div>
<p>The API returns the resource state with its <em>resourceVersion</em>.
Each time the resource is updated, the API automatically update the version number.</p>
<p>You can run the update request below using:</p>
<div class="highlight"><pre><span></span>curl -XVERB -H <span class="s2">&quot;Content-Type: TYPE&quot;</span> http://localhost:8080/apis/apps/v1/namespaces/tristanc/deployments/demo-deployment --data-binary @- <span class="s">&lt;&lt;EOF</span>
<span class="s">  BODY</span>
<span class="s">EOF</span>
</pre></div>
</div>
<div class="section" id="json-patch">
<h2>JSON Patch</h2>
<p>A <a class="reference external" href="https://tools.ietf.org/html/rfc6902">JSON Patch RFC 6902</a> is defined by a <strong>op</strong> operation, <strong>path</strong> destination and a <strong>value</strong>.</p>
<div class="highlight"><pre><span></span>curl -XPATCH -H <span class="s2">&quot;Content-Type: application/json-patch+json&quot;</span>
</pre></div>
<div class="section" id="add-a-container">
<h3>Add a container</h3>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;add&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/spec/template/spec/containers/-&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;container-2&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sleep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;infinity&quot;</span><span class="p">],</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;image&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;registry.fedoraproject.org/fedora:latest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;imagePullPolicy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;IfNotPresent&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="remove-a-container">
<h3>Remove a container</h3>
<p>List indices are zero based.</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;remove&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/spec/template/spec/containers/1&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="change-the-image">
<h3>Change the image</h3>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;replace&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="nt">&quot;/spec/template/spec/containers/0/image&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;registry.fedoraproject.org/fedora:36&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="test">
<h3>Test</h3>
<p>A JSON Patch can also assert a desired state:</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;op&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/spec/template/spec/containers/0/image&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;registry.fedoraproject.org/fedora:37&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="json-merge-patch">
<h2>JSON Merge Patch</h2>
<p>A <a class="reference external" href="https://tools.ietf.org/html/rfc7386">JSON Merge Patch RFC 7396</a> is more similar to a diff.
List elements can't be manipulated and the full list needs to be provided.</p>
<div class="highlight"><pre><span></span>curl -XPATCH -H <span class="s2">&quot;Content-Type: application/merge-patch+json&quot;</span>
</pre></div>
<div class="section" id="change-containers">
<h3>Change containers</h3>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;template&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;containers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;container-1&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sleep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;infinity&quot;</span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;image&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;registry.fedoraproject.org/fedora:latest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;imagePullPolicy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;IfNotPresent&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;container-2&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sleep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;infinity&quot;</span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;image&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;registry.fedoraproject.org/fedora:latest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;imagePullPolicy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;IfNotPresent&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">}]</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="section" id="change-replica-count">
<h3>Change replica count</h3>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;replicas&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="strategic-merge-patch">
<h2>Strategic Merge Patch</h2>
<p>A strategic patch is similar to a JSON Merge Patch, but with custom behaviors defined in the OpenAPI.
For example, the pod template spec enables adding containers to the list.</p>
<div class="highlight"><pre><span></span>curl -XPATCH -H <span class="s2">&quot;Content-Type: application/strategic-merge-patch+json&quot;</span>
</pre></div>
<div class="section" id="add-a-container-1">
<h3>Add a container</h3>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;template&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="nt">&quot;spec&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="nt">&quot;containers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;container-2&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;args&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sleep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;infinity&quot;</span><span class="p">],</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;image&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;registry.fedoraproject.org/fedora:latest&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nt">&quot;imagePullPolicy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;IfNotPresent&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">}]</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="server-side-apply">
<h2>Server Side Apply</h2>
<p>Since Kubernetes v1.22, a new option is available when using:</p>
<div class="highlight"><pre><span></span>curl -XPATCH -H <span class="s2">&quot;Content-Type: application/apply-patch+yaml&quot;</span>
</pre></div>
<p>This feature leverage a new &quot;field management&quot; mechanism, and it seems useful when multiple clients
are updating a single resource.
This feature is fairly new, and it is not yet fully supported by the controller-runtime client.</p>
</div>
<div class="section" id="replace">
<h2>Replace</h2>
<p>The other solution is to replace the resource:</p>
<div class="highlight"><pre><span></span>curl -XPUT -H <span class="s2">&quot;Content-Type: application/json&quot;</span>
</pre></div>
<p>The body must contains the full resource, otherwise the request will fail.</p>
<div class="section" id="get-and-replace">
<h3>Get and replace</h3>
<div class="highlight"><pre><span></span>curl http://localhost:8080/apis/apps/v1/namespaces/tristanc/deployments/demo-deployment &gt; dep.json
<span class="c1"># edit the file</span>
curl -XPUT -H <span class="s2">&quot;Content-Type: application/json&quot;</span> http://localhost:8080/apis/apps/v1/namespaces/tristanc/deployments/demo-deployment -d@dep.json
</pre></div>
<p>Notice that changing the resource results in a new <em>resourceVersion</em>, and trying to repeat the last request will fails because the version no longer match.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Kubernetes provides multiple update strategies to manage resources:</p>
<ul class="simple">
<li>The easiest option seems to be the Strategic Merge Patch, or the new Server Side Apply, but the resulting update depend on the nature of the change,
for example it is not clear how to remove an element from a list.</li>
<li>JSON Patch seems to be the most efficient, but the request body needs to be prepared. JSON Merge Patch is another solution,
but removing attributes requires using a <em>null</em> value. Learn more about the difference in this <a class="reference external" href="https://erosb.github.io/post/json-patch-vs-merge-patch/">post</a>.</li>
<li>Finally replace seems to be most straightforward solution, but the full resources needs to be known in advance.</li>
</ul>
<p>The controller-runtime provides a convenient Update method to use the replace strategy: <a class="reference external" href="https://pkg.go.dev/sigs.k8s.io/controller-runtime/pkg/client#example-Client-Update">Example Client Update</a>.
This pattern works great in the context of an operator where the state of the resources is usually known before making creation or update request.</p>
</div>

            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./sprint-2024-aug-09-to-2024-aug-28-summary.html">Sprint 2024 Aug 09 to 2024 Aug 28 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jul-19-to-2024-aug-07-summary.html">Sprint 2024 Jul 19 to 2024 Aug 07 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-28-to-2024-jul-17-summary.html">Sprint 2024 Jun 28 to 2024 Jul 17 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-jun-07-to-2024-jun-26-summary.html">Sprint 2024 Jun 07 to 2024 Jun 26 summary</a></li>
    <li class="list-group-item"><a href="./sprint-2024-may-16-to-2024-jun-05-summary.html">Sprint 2024 May 16 to 2024 Jun 05 summary</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 Red Hat
           &middot; Powered by <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>
           &middot; This work is licensed under a
               <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                 Creative Commons Attribution 4.0 International License
               </a>.
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>




</body>
</html>